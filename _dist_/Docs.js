import"./Docs.css.proxy.js";import{createElement as t,Fragment as F,useEffect as q,useState as A}from"../web_modules/react.js";import E from"../web_modules/recoil.js";const V="https://curtiz-japanese-nlp.glitch.me/api/v1/sentences",j=E.atom({key:"docs",default:{}}),M=E.selectorFamily({key:"doc",get:e=>({get:n})=>n(j)[e]}),G=E.selectorFamily({key:"wordIdToSentence",get:e=>({get:n})=>{const s=new Map(),o=n(M(e));if(!o||!o.annotated)return s;for(const[a,r]of o.annotated.entries()){if(!r)continue;const i=o.contents[a];for(const{wordId:_}of r.hits)s.set(_,(s.get(_)||[]).concat({sentence:i,lino:a}))}return s}}),z=E.atom({key:"clickedMorpheme",default:void 0});import H from"../web_modules/pouchdb-browser.js";import J from"../web_modules/pouchdb-upsert.js";H.plugin(J);const S=new H("sidecar-docs");function $(e){return`doc-${e}`}async function L(){const e=$(""),n=await S.allDocs({startkey:e,endkey:e+"️",include_docs:!0}),s={};for(const{doc:o}of n.rows)if(o){const a={name:o.name,unique:o.unique,contents:o.contents,raws:o.raws,annotated:o.annotated,overrides:o.overrides};s[o.unique]=a}return s}async function K(e){return S.upsert($(e),()=>({_deleted:!0}))}async function W(){const e=[];return new Promise((n,s)=>{S.changes({filter:o=>o._deleted}).on("change",o=>e.push(o.id)).on("complete",()=>{n(e)}).on("error",o=>s(o))})}async function Q(){const e=await W(),n=await Promise.all(e.map(o=>S.get(o,{revs:!0,open_revs:"all"}).then(a=>{const r=a[0].ok._revisions,i=r.start-1+"-"+r.ids[1],_=S.get(o,{rev:i});return _}))),s=n.map(({name:o,unique:a,contents:r,raws:i,annotated:_,overrides:f})=>({name:o,unique:a,contents:r,raws:i,annotated:_,overrides:f}));return s}export function DocsComponent({}){const[e,n]=E.useRecoilState(j),[s,o]=A(!1);q(()=>{s||(async()=>{const i=await L();Object.keys(i).length>0&&n(i),o(!0)})()},[s]);const a=t("div",{id:"all-docs",className:"left-containee"},...Object.keys(e).map(i=>t(X,{unique:i})),t(B),t(se),t(re)),r=t("div",{className:"right-containee"},t(ee));return t("div",{className:"container"},a,r)}function X({unique:e}){const n=E.useRecoilValue(M(e)),s=E.useSetRecoilState(j),o=E.useSetRecoilState(z),[a,r]=A(!1);if(!n)return t(F);const i=t("button",{onClick:()=>K(e).then(()=>s(u=>{const d={...u};return delete d[e],d}))},"Delete"),_=t("button",{onClick:()=>r(!a)},a?"Cancel":"Edit"),f=n.overrides,m=a?t(B,{existing:n,done:()=>r(!a)}):t("section",null,...n.raws.map((u,d)=>u?t(Z,{rawAnalysis:u,annotated:n.annotated[d],docUnique:e,lineNumber:d,overrides:f}):t("p",{onClick:()=>o(void 0)},n.contents[d])));return t("div",{className:"doc"},t("h2",null,n.name||e,i,_),m,t(ae,{overrides:n.overrides,docUnique:e}),t(Y,{doc:n}))}function Y({doc:e}){return t("details",{className:"regular-sized limited-height"},t("summary",null,"All dictionary annotations"),t("ol",null,...e.annotated.flatMap(n=>n?.hits.map(s=>t("li",null,s.summary))).filter(n=>!!n)))}function Z({rawAnalysis:e,docUnique:n,lineNumber:s,annotated:o,overrides:a}){const r=E.useSetRecoilState(z),{furigana:i,hits:_}=e,f={docUnique:n,lineNumber:s,annotations:o,overrides:a},m=new Set();if(o)for(const{startIdx:d,endIdx:g}of o.hits)for(let w=d;w<g;w++)m.add(w);const u=m.size>0?d=>m.has(d)?"annotated-text":void 0:()=>{};return t("p",{id:`${n}-${s}`},...i.map((d,g)=>o?.furigana[g]||a[O(d)]||d).flatMap((d,g)=>d.map(w=>{const P={...f,rawHits:_[g],morpheme:{rawFurigana:e.furigana[g],annotatedFurigana:o?.furigana[g]},morphemeIdx:g,kanjidic:e.kanjidic||{}};return typeof w=="string"?t("span",{className:u(g),onClick:()=>r(P)},w):t("ruby",{className:u(g),onClick:()=>r(P)},w.ruby,t("rt",null,w.rt))})))}function B({existing:e,done:n}){const[s,o]=A(e?e.name:""),[a,r]=A(e?e.contents.join(`
`):""),i=E.useSetRecoilState(j),_=t("input",{type:"text",value:s,onChange:u=>o(u.target.value)}),f=t("textarea",{value:a,onChange:u=>r(u.currentTarget.value)}),m=t("button",{onClick:async()=>{const u=a.split(`
`);let d=new Map(e?e.contents.map((P,x)=>[P,x]):[]),g=e?u.filter(P=>!d.has(P)):u;const w=await fetch(V,{body:JSON.stringify({sentences:g}),headers:{"Content-Type":"application/json"},method:"POST"});if(w.ok){const P=[],x=[],T=await w.json();{let c=0;for(const h of u){const y=d.get(h);if(e&&y!==void 0)P.push(e.raws[y]),x.push(e.annotated[y]);else{const b=T[c];P.push(typeof b=="string"?void 0:{sha1:await ie(h,"sha-1"),text:h,hits:b.hits,furigana:b.furigana,kanjidic:b.kanjidic}),x.push(void 0),c++}}}const D=e?e.unique:new Date().toISOString();P.length===x.length&&x.length===u.length||console.error("Warning: unexpected length of lines vs raw analysis vs annotated analysis",{raws:P,annotated:x,contents:u});const l={name:s,unique:D,contents:u,raws:P,annotated:x,overrides:e?e.overrides:{}};if(e)for(const[c,h]of e.annotated.entries()){const y=l.raws[c],b=e.raws[c];if(!h||!y||!b||l.annotated[c])continue;const p={sha1:y.sha1,text:y.text,furigana:[],hits:[]},v=new Map();for(const R of h.furigana)R&&v.set(O(R),R);p.furigana=y.furigana.map(R=>v.get(O(R))||R);const U=y.furigana.map(O);for(const R of h.hits){const k=b.furigana.slice(R.startIdx,R.endIdx).map(O),I=le(U,k);if(I>=0){const C=_e(ue(U.slice(0,I).join(""),k.join(""),U.slice(I+k.length).join("")));p.hits.push({summary:R.summary,wordId:R.wordId,run:C,startIdx:I,endIdx:I+k.length})}}l.annotated[c]=p}S.upsert($(D),()=>l).then(()=>i(c=>({...c,[D]:l}))).then(()=>n?n():"")}else console.error("error parsing sentences: "+w.statusText)}},"Submit");return t("div",null,e?"":t("h2",null,"Create a new document"),_,t("br"),f,t("br"),m)}function ee({}){const e=E.useRecoilValue(z),n=E.useSetRecoilState(j),s=E.useSetRecoilState(z),o=E.useRecoilValue(G(e?.docUnique||""));if(!e)return t("div",null);const{rawHits:a,annotations:r,lineNumber:i,docUnique:_,morphemeIdx:f,morpheme:{rawFurigana:m},kanjidic:u}=e,d=new Set(r?.hits?.map(l=>l.wordId+N(l.run)));function g(l,c,h,y){n(b=>{const p={...b},v=b[_];if(v){const U={...v};U.annotated=U.annotated.slice();const R=U.annotated[i];if(R){const k=N(c),I=R.hits.findIndex(C=>C.wordId===l.wordId&&N(C.run)===k);if(I>=0){const C=R.hits.slice();C.splice(I,1),U.annotated[i]={...R,hits:C}}else{const C={run:c,startIdx:h,endIdx:y,wordId:l.wordId,summary:l.summary};U.annotated[i]={...R,hits:R.hits.concat(C)}}}else{const k={run:c,startIdx:h,endIdx:y,wordId:l.wordId,summary:l.summary};U.annotated[i]={furigana:Array.from(Array(U.raws[i]?.furigana.length)),hits:[k],sha1:U.raws[i]?.sha1||"",text:U.raws[i]?.text||""}}p[_]=U,s(k=>k&&{...k,annotations:U.annotated[i]}),S.upsert($(_),()=>({...U}))}return p})}const w=O(m).split("").filter(l=>l in u).map(l=>u[l]),P=w.length?t("div",null,t("h3",null,"Kanjidic"),t("ol",null,...w.map(l=>t("li",null,summarizeCharacter(l),l.dependencies?.length?t("ul",null,...l.dependencies.map(c=>t("li",null,c.nodeMapped?summarizeCharacter(c.nodeMapped):c.node))):void 0)))):"",x=new Set(a.results.flatMap(l=>l.results.map(c=>c.wordId))),T=r?.hits?.filter(l=>x.has(l.wordId))||[],D=T.length?t("div",null,t("h3",null,"All uses"),t("ul",null,...T.map(l=>t("li",null,l.summary,t("ol",null,...(o.get(l.wordId)||[]).map(({sentence:c,lino:h})=>t("li",null,t("a",{href:`#${_}-${h}`},te(l.run,c))))))))):"";return t("div",null,...a.results.map(l=>t("ol",null,...l.results.map(c=>{const h=d.has(c.wordId+N(l.run));return t("li",{className:h?"annotated-entry":void 0},...ne(l.run,c.summary),t("button",{onClick:()=>g(c,l.run,a.startIdx,l.endIdx)},h?"Entry highlighted! Remove?":"Create highlight?"))}))),t(oe,{morpheme:e.morpheme,overrides:e.overrides,docUnique:_,lineNumber:i,morphemeIdx:f,key:`${_}${i}${f}`}),P,D)}function te(e,n){const s=N(e),o=n.indexOf(s);return o<0?n:"…"+n.slice(Math.max(0,o-5),o+s.length+5)+"…"}function ne(e,n){const s=new Set((typeof e=="string"?e:e.cloze).split(""));return n.split("").map(o=>s.has(o)?t("span",{className:"highlighted"},o):o)}export function summarizeCharacter(e){const{literal:n,readings:s,meanings:o,nanori:a}=e;return`${n}： ${s.join(", ")} ${o.join("; ")}`+(a.length?` (names: ${a.join(", ")})`:"")}function oe({morpheme:e,overrides:n,docUnique:s,lineNumber:o,morphemeIdx:a}){const r=(e?.annotatedFurigana||e?.rawFurigana||[]).filter(c=>typeof c!="string"),i=O(e?.annotatedFurigana||e?.rawFurigana||[]),_=E.useSetRecoilState(j),f=r.map(c=>c.rt),m=i in n,[u,d]=A(f),[g,w]=A(m);if(r.length===0||!e)return t(F);const P=u.map((c,h)=>t("input",{type:"text",value:c,onChange:y=>d(u.map((b,p)=>p===h?y.target.value:b))})),x=t("input",{type:"checkbox",name:"globalCheckbox",checked:g,onChange:()=>w(!g)}),T=t("label",{htmlFor:"globalCheckbox"},"Global override?"),D=t("button",{onClick:()=>{_(c=>{const h=[];{let p=0;for(const v of e.rawFurigana)h.push(typeof v=="string"?v:{ruby:v.ruby,rt:u[p++]})}const y=c[s],b=y?.raws[o];if(y&&b){const p={...y};if(g)p.overrides={...p.overrides,[i]:h};else{p.annotated=p.annotated.slice();const v=p.annotated[o]?{...p.annotated[o]}:{text:b.text,sha1:b.sha1,furigana:Array.from(Array(b.furigana.length)),hits:[]};v.furigana=v.furigana.slice(),v.furigana[a]=h,p.annotated[o]=v}return S.upsert($(s),()=>({...p})),{...c,[s]:p}}return c})}},"Submit override"),l=t("button",{onClick:()=>{d(f),w(m)}},"Cancel");return t("div",null,t("h3",null,"Override for: "+i),t("ol",null,...r.map((c,h)=>t("li",null,c.ruby+" ",P[h]))),T,x,D)}function se(){const e=E.useSetRecoilState(j),[n,s]=A([]),o=t("button",{onClick:()=>Q().then(r=>s(r))},"Refresh deleted docs"),a=r=>S.upsert(r.unique,()=>r).then(()=>e(i=>({...i,[r.unique]:r})));return t("div",null,t("h2",null,"Deleted"),o,t("ol",null,...n.map(r=>t("li",null,`${r.name} (${r.unique}): ${r.contents.join(" ").slice(0,15)}…`,t("button",{onClick:()=>a(r)},"Undelete")))))}function ae({overrides:e,docUnique:n}){const s=E.useSetRecoilState(j),o=Object.keys(e);return o.length===0?t(F):t("div",null,t("h3",null,"Overrides"),t("ol",null,...o.map(a=>{const r=()=>s(f=>{const m={...f[n]};return m.overrides={...m.overrides},delete m.overrides[a],S.upsert($(n),()=>({...m})),{...f,[n]:m}}),i=e[a].map(f=>typeof f=="string"?f:t("ruby",null,f.ruby,t("rt",null,f.rt))),_=t("button",{onClick:r},"Delete");return t("li",null,`${a} → `,...i," ",_)})))}function re(){return t("button",{onClick:async()=>{await S.compact();const e=await L(),n=new Blob([JSON.stringify(e)],{type:"application/json"}),s=document.createElement("a");s.href=URL.createObjectURL(n),s.download=`kanda-${new Date().toISOString().replace(/:/g,".")}.json`,document.body.appendChild(s),s.click()}},"Export")}async function ie(e,n){const s=new TextEncoder().encode(e),o=await crypto.subtle.digest(n,s),a=Array.from(new Uint8Array(o)),r=a.map(i=>i.toString(16).padStart(2,"0")).join("");return r}function N(e){return typeof e=="string"?e:`${e.left}${e.cloze}${e.right}`}function O(e){return e.map(n=>typeof n=="string"?n:n.ruby).join("")}function le(e,n,s=0){if(n.length>e.length)return-1;e:for(let o=s;o<e.length-n.length+1;o++){for(let a=0;a<n.length;a++)if(e[o+a]!==n[a])continue e;return o}return-1}function ce(e,n){const s=e.indexOf(n);return s>=0&&e.indexOf(n,s+1)<0}function ue(e,n,s){const o=e+n+s;let a="",r="",i=0;for(;!ce(o,a+n+r);){if(i++,i>e.length&&i>s.length)throw console.error({sentence:o,left:e,cloze:n,right:s,leftContext:a,rightContext:r,contextLength:i}),new Error("Ran out of context to build unique cloze");a=e.slice(-i),r=s.slice(0,i)}return{left:a,cloze:n,right:r}}function _e(e){return!e.right&&!e.left?e.cloze:e}
