import"./Docs.css.proxy.js";import{createElement as t,Fragment as z,useEffect as B,useState as I}from"../web_modules/react.js";import E from"../web_modules/recoil.js";const L="https://curtiz-japanese-nlp.glitch.me/api/v1/sentences",j=E.atom({key:"docs",default:{}}),q=E.selectorFamily({key:"doc",get:e=>({get:n})=>n(j)[e]}),$=E.atom({key:"clickedMorpheme",default:void 0});import F from"../web_modules/pouchdb-browser.js";import G from"../web_modules/pouchdb-upsert.js";F.plugin(G);const x=new F("sidecar-docs");function A(e){return`doc-${e}`}async function V(){const e=A(""),n=await x.allDocs({startkey:e,endkey:e+"️",include_docs:!0}),a={};for(const{doc:o}of n.rows)if(o){const r={name:o.name,unique:o.unique,contents:o.contents,raws:o.raws,annotated:o.annotated,overrides:o.overrides};a[o.unique]=r}return a}async function J(e){return x.upsert(A(e),()=>({_deleted:!0}))}async function K(){const e=[];return new Promise((n,a)=>{x.changes({filter:o=>o._deleted}).on("change",o=>e.push(o.id)).on("complete",()=>{n(e)}).on("error",o=>a(o))})}async function W(){const e=await K(),n=await Promise.all(e.map(o=>x.get(o,{revs:!0,open_revs:"all"}).then(r=>{const s=r[0].ok._revisions,i=s.start-1+"-"+s.ids[1],R=x.get(o,{rev:i});return R}))),a=n.map(({name:o,unique:r,contents:s,raws:i,annotated:R,overrides:m})=>({name:o,unique:r,contents:s,raws:i,annotated:R,overrides:m}));return a}export function DocsComponent({}){const[e,n]=E.useRecoilState(j),[a,o]=I(!1);B(()=>{a||(async()=>{const i=await V();Object.keys(i).length>0&&n(i),o(!0)})()},[a]);const r=t("div",{id:"all-docs",className:"left-containee"},...Object.keys(e).map(i=>t(Q,{unique:i})),t(H),t(ne)),s=t("div",{className:"right-containee"},t(Z));return t("div",{className:"container"},r,s)}function Q({unique:e}){const n=E.useRecoilValue(q(e)),a=E.useSetRecoilState(j),o=E.useSetRecoilState($),[r,s]=I(!1);if(!n)return t(z);const i=t("button",{onClick:()=>J(e).then(()=>a(u=>{const f={...u};return delete f[e],f}))},"Delete"),R=t("button",{onClick:()=>s(!r)},r?"Cancel":"Edit"),m=n.overrides,g=r?t(H,{existing:n,done:()=>s(!r)}):t("section",null,...n.raws.map((u,f)=>u?t(Y,{rawAnalysis:u,annotated:n.annotated[f],docUnique:e,lineNumber:f,overrides:m}):t("p",{onClick:()=>o(void 0)},n.contents[f])));return t("div",{className:"doc"},t("h2",null,n.name||e,i,R),g,t(oe,{overrides:n.overrides,docUnique:e}),t(X,{doc:n}))}function X({doc:e}){return t("details",{className:"regular-sized limited-height"},t("summary",null,"All dictionary annotations"),t("ol",null,...e.annotated.flatMap(n=>n?.hits.map(a=>t("li",null,a.summary))).filter(n=>!!n)))}function Y({rawAnalysis:e,docUnique:n,lineNumber:a,annotated:o,overrides:r}){const s=E.useSetRecoilState($),{furigana:i,hits:R}=e,m={docUnique:n,lineNumber:a,annotations:o,overrides:r},g=new Set();if(o)for(const{startIdx:f,endIdx:y}of o.hits)for(let b=f;b<y;b++)g.add(b);const u=g.size>0?f=>g.has(f)?"annotated-text":void 0:()=>{};return t("p",null,...i.map((f,y)=>o?.furigana[y]||r[D(f)]||f).flatMap((f,y)=>f.map(b=>{const l={...m,rawHits:R[y],morpheme:{rawFurigana:e.furigana[y],annotatedFurigana:o?.furigana[y]},morphemeIdx:y,kanjidic:e.kanjidic||{}};return typeof b=="string"?t("span",{className:u(y),onClick:()=>s(l)},b):t("ruby",{className:u(y),onClick:()=>s(l)},b.ruby,t("rt",null,b.rt))})))}function H({existing:e,done:n}){const[a,o]=I(e?e.name:""),[r,s]=I(e?e.contents.join(`
`):""),i=E.useSetRecoilState(j),R=t("input",{type:"text",value:a,onChange:u=>o(u.target.value)}),m=t("textarea",{value:r,onChange:u=>s(u.currentTarget.value)}),g=t("button",{onClick:async()=>{const u=r.split(`
`);let f=new Map(e?e.contents.map((l,d)=>[l,d]):[]),y=e?u.filter(l=>!f.has(l)):u;const b=await fetch(L,{body:JSON.stringify({sentences:y}),headers:{"Content-Type":"application/json"},method:"POST"});if(b.ok){const l=[],d=[],k=await b.json();{let h=0;for(const w of u){const c=f.get(w);if(e&&c!==void 0)l.push(e.raws[c]),d.push(e.annotated[c]);else{const p=k[h];l.push(typeof p=="string"?void 0:{sha1:await se(w,"sha-1"),text:w,hits:p.hits,furigana:p.furigana,kanjidic:p.kanjidic}),d.push(void 0),h++}}}const S=e?e.unique:new Date().toISOString();l.length===d.length&&d.length===u.length||console.error("Warning: unexpected length of lines vs raw analysis vs annotated analysis",{raws:l,annotated:d,contents:u});const C={name:a,unique:S,contents:u,raws:l,annotated:d,overrides:e?e.overrides:{}};if(e)for(const[h,w]of e.annotated.entries()){const c=C.raws[h],p=e.raws[h];if(!w||!c||!p||C.annotated[h])continue;const _={sha1:c.sha1,text:c.text,furigana:[],hits:[]},P=new Map();for(const v of w.furigana)v&&P.set(D(v),v);_.furigana=c.furigana.map(v=>P.get(D(v))||v);const U=c.furigana.map(D);for(const v of w.hits){const T=p.furigana.slice(v.startIdx,v.endIdx).map(D),O=ae(U,T);if(O>=0){const M=le(ie(U.slice(0,O).join(""),T.join(""),U.slice(O+T.length).join("")));_.hits.push({summary:v.summary,wordId:v.wordId,run:M,startIdx:O,endIdx:O+T.length})}}C.annotated[h]=_}x.upsert(A(S),()=>C).then(()=>i(h=>({...h,[S]:C}))).then(()=>n?n():"")}else console.error("error parsing sentences: "+b.statusText)}},"Submit");return t("div",null,e?"":t("h2",null,"Create a new document"),R,t("br"),m,t("br"),g)}function Z({}){const e=E.useRecoilValue($),n=E.useSetRecoilState(j),a=E.useSetRecoilState($);if(!e)return t("div",null);const{rawHits:o,annotations:r,lineNumber:s,docUnique:i,morphemeIdx:R,morpheme:{rawFurigana:m},kanjidic:g}=e,u=new Set();if(r)for(const{wordId:l,run:d}of r.hits)u.add(l+N(d));function f(l,d,k,S){n(C=>{const h={...C},w=C[i];if(w){const c={...w};c.annotated=c.annotated.slice();const p=c.annotated[s];if(p){const _=N(d),P=p.hits.findIndex(U=>U.wordId===l.wordId&&N(U.run)===_);if(P>=0){const U=p.hits.slice();U.splice(P,1),c.annotated[s]={...p,hits:U}}else{const U={run:d,startIdx:k,endIdx:S,wordId:l.wordId,summary:l.summary};c.annotated[s]={...p,hits:p.hits.concat(U)}}}else{const _={run:d,startIdx:k,endIdx:S,wordId:l.wordId,summary:l.summary};c.annotated[s]={furigana:Array.from(Array(c.raws[s]?.furigana.length)),hits:[_],sha1:c.raws[s]?.sha1||"",text:c.raws[s]?.text||""}}h[i]=c,a(_=>_&&{..._,annotations:c.annotated[s]}),x.upsert(A(i),()=>({...c}))}return h})}const y=D(m).split("").filter(l=>l in g).map(l=>g[l]),b=y.length?t("div",null,t("h3",null,"Kanjidic"),t("ol",null,y.map(l=>t("li",null,summarizeCharacter(l),l.dependencies?.length?t("ul",null,...l.dependencies.map(d=>t("li",null,d.nodeMapped?summarizeCharacter(d.nodeMapped):d.node))):void 0)))):"";return t("div",null,...o.results.map(l=>t("ol",null,...l.results.map(d=>{const k=u.has(d.wordId+N(l.run));return t("li",{className:k?"annotated-entry":void 0},...ee(l.run,d.summary),t("button",{onClick:()=>f(d,l.run,o.startIdx,l.endIdx)},k?"Entry highlighted! Remove?":"Create highlight?"))}))),t(te,{morpheme:e.morpheme,overrides:e.overrides,docUnique:i,lineNumber:s,morphemeIdx:R,key:`${i}${s}${R}`}),b)}function ee(e,n){const a=new Set((typeof e=="string"?e:e.cloze).split(""));return n.split("").map(o=>a.has(o)?t("span",{className:"highlighted"},o):o)}export function summarizeCharacter(e){const{literal:n,readings:a,meanings:o,nanori:r}=e;return`${n}： ${a.join(", ")} ${o.join("; ")}`+(r.length?` (names: ${r.join(", ")})`:"")}function te({morpheme:e,overrides:n,docUnique:a,lineNumber:o,morphemeIdx:r}){const s=(e?.annotatedFurigana||e?.rawFurigana||[]).filter(h=>typeof h!="string"),i=D(e?.annotatedFurigana||e?.rawFurigana||[]),R=E.useSetRecoilState(j),m=s.map(h=>h.rt),g=i in n,[u,f]=I(m),[y,b]=I(g);if(s.length===0||!e)return t(z);const l=u.map((h,w)=>t("input",{type:"text",value:h,onChange:c=>f(u.map((p,_)=>_===w?c.target.value:p))})),d=t("input",{type:"checkbox",name:"globalCheckbox",checked:y,onChange:()=>b(!y)}),k=t("label",{htmlFor:"globalCheckbox"},"Global override?"),S=t("button",{onClick:()=>{R(h=>{const w=[];{let _=0;for(const P of e.rawFurigana)w.push(typeof P=="string"?P:{ruby:P.ruby,rt:u[_++]})}const c=h[a],p=c?.raws[o];if(c&&p){const _={...c};if(y)_.overrides={..._.overrides,[i]:w};else{_.annotated=_.annotated.slice();const P=_.annotated[o]?{..._.annotated[o]}:{text:p.text,sha1:p.sha1,furigana:Array.from(Array(p.furigana.length)),hits:[]};P.furigana=P.furigana.slice(),P.furigana[r]=w,_.annotated[o]=P}return x.upsert(A(a),()=>({..._})),{...h,[a]:_}}return h})}},"Submit override"),C=t("button",{onClick:()=>{f(m),b(g)}},"Cancel");return t("div",null,t("h3",null,"Override for: "+i),t("ol",null,...s.map((h,w)=>t("li",null,h.ruby+" ",l[w]))),k,d,S)}function ne(){const e=E.useSetRecoilState(j),[n,a]=I([]),o=t("button",{onClick:()=>W().then(s=>a(s))},"Refresh deleted docs"),r=s=>x.upsert(s.unique,()=>s).then(()=>e(i=>({...i,[s.unique]:s})));return t("div",null,t("h2",null,"Deleted"),o,t("ol",null,...n.map(s=>t("li",null,`${s.name} (${s.unique}): ${s.contents.join(" ").slice(0,15)}…`,t("button",{onClick:()=>r(s)},"Undelete")))))}function oe({overrides:e,docUnique:n}){const a=E.useSetRecoilState(j),o=Object.keys(e);return o.length===0?t(z):t("div",null,t("h3",null,"Overrides"),t("ol",null,...o.map(r=>{const s=()=>a(m=>{const g={...m[n]};return g.overrides={...g.overrides},delete g.overrides[r],x.upsert(A(n),()=>({...g})),{...m,[n]:g}}),i=e[r].map(m=>typeof m=="string"?m:t("ruby",null,m.ruby,t("rt",null,m.rt))),R=t("button",{onClick:s},"Delete");return t("li",null,`${r} → `,...i," ",R)})))}async function se(e,n){const a=new TextEncoder().encode(e),o=await crypto.subtle.digest(n,a),r=Array.from(new Uint8Array(o)),s=r.map(i=>i.toString(16).padStart(2,"0")).join("");return s}function N(e){return typeof e=="string"?e:`${e.left}${e.cloze}${e.right}`}function D(e){return e.map(n=>typeof n=="string"?n:n.ruby).join("")}function ae(e,n,a=0){if(n.length>e.length)return-1;e:for(let o=a;o<e.length-n.length+1;o++){for(let r=0;r<n.length;r++)if(e[o+r]!==n[r])continue e;return o}return-1}function re(e,n){const a=e.indexOf(n);return a>=0&&e.indexOf(n,a+1)<0}function ie(e,n,a){const o=e+n+a;let r="",s="",i=0;for(;!re(o,r+n+s);){if(i++,i>e.length&&i>a.length)throw console.error({sentence:o,left:e,cloze:n,right:a,leftContext:r,rightContext:s,contextLength:i}),new Error("Ran out of context to build unique cloze");r=e.slice(-i),s=a.slice(0,i)}return{left:r,cloze:n,right:s}}function le(e){return!e.right&&!e.left?e.cloze:e}
