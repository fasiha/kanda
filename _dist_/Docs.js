import"./Docs.css.proxy.js";import{createElement as b,Fragment as L,useEffect as Q,useState as D}from"../web_modules/react.js";import v from"../web_modules/recoil.js";const R="https://curtiz-japanese-nlp.glitch.me/api/v1/sentences",C=v.atom({key:"docs",default:{}}),S=v.selectorFamily({key:"doc",get:a=>({get:c})=>c(C)[a]}),I=v.atom({key:"clickedMorpheme",default:void 0});import N from"../web_modules/pouchdb-browser.js";import T from"../web_modules/pouchdb-upsert.js";N.plugin(T);const B=new N("sidecar-docs");function E(a){return`doc-${a}`}async function U(){const a=E(""),c=await B.allDocs({startkey:a,endkey:a+"️",include_docs:!0}),f={};for(const{doc:d}of c.rows)if(d){const g={name:d.name,unique:d.unique,contents:d.contents,raws:d.raws,annotated:d.annotated,overrides:d.overrides};f[d.unique]=g}return f}async function V(a){return B.upsert(E(a),()=>({_deleted:!0}))}async function W(){const a=[];return new Promise((c,f)=>{B.changes({filter:d=>d._deleted}).on("change",d=>a.push(d.id)).on("complete",()=>{c(a)}).on("error",d=>f(d))})}async function X(){const a=await W(),c=await Promise.all(a.map(d=>B.get(d,{revs:!0,open_revs:"all"}).then(g=>{const e=g[0].ok._revisions,h=e.start-1+"-"+e.ids[1],u=B.get(d,{rev:h});return u}))),f=c.map(({name:d,unique:g,contents:e,raws:h,annotated:u,overrides:n})=>({name:d,unique:g,contents:e,raws:h,annotated:u,overrides:n}));return f}export function DocsComponent({}){const[a,c]=v.useRecoilState(C),[f,d]=D(!1);Q(()=>{f||(async()=>{const h=await U();Object.keys(h).length>0&&c(h),d(!0)})()},[f]);const g=b("div",{id:"all-docs",className:"left-containee"},...Object.keys(a).map(h=>b(Y,{unique:h})),b(O),b(ca)),e=b("div",{className:"right-containee"},b($));return b("div",{className:"container"},g,e)}function Y({unique:a}){const c=v.useRecoilValue(S(a)),f=v.useSetRecoilState(C),d=v.useSetRecoilState(I),[g,e]=D(!1);if(!c)return b(L);const h=b("button",{onClick:()=>V(a).then(()=>f(i=>{const j={...i};return delete j[a],j}))},"Delete"),u=b("button",{onClick:()=>e(!g)},g?"Cancel":"Edit"),n=c.overrides,o=g?b(O,{existing:c,done:()=>e(!g)}):b("section",null,...c.raws.map((i,j)=>i?b(_,{rawAnalysis:i,annotated:c.annotated[j],docUnique:a,lineNumber:j,overrides:n}):b("p",{onClick:()=>d(void 0)},c.contents[j])));return b("div",{className:"doc"},b("h2",null,c.name||a,h,u),o,b(da,{overrides:c.overrides,docUnique:a}),b(Z,{doc:c}))}function Z({doc:a}){return b("details",{className:"regular-sized"},b("summary",null,"All dictionary annotations"),b("ol",null,...a.annotated.flatMap(c=>c?.hits.map(f=>b("li",null,f.summary))).filter(c=>!!c)))}function _({rawAnalysis:a,docUnique:c,lineNumber:f,annotated:d,overrides:g}){const e=v.useSetRecoilState(I),{furigana:h,hits:u}=a,n={docUnique:c,lineNumber:f,annotations:d,overrides:g},o=new Set();if(d)for(const{startIdx:j,endIdx:m}of d.hits)for(let p=j;p<m;p++)o.add(p);const i=o.size>0?j=>o.has(j)?"annotated-text":void 0:()=>{};return b("p",null,...h.map((j,m)=>d?.furigana[m]||g[F(j)]||j).flatMap((j,m)=>j.map(p=>{const s={...n,rawHits:u[m],morpheme:{rawFurigana:a.furigana[m],annotatedFurigana:d?.furigana[m]},morphemeIdx:m};return typeof p==="string"?b("span",{className:i(m),onClick:()=>e(s)},p):b("ruby",{className:i(m),onClick:()=>e(s)},p.ruby,b("rt",null,p.rt))})))}function O({existing:a,done:c}){const[f,d]=D(a?a.name:""),[g,e]=D(a?a.contents.join(`
`):""),h=v.useSetRecoilState(C),u=b("input",{type:"text",value:f,onChange:i=>d(i.target.value)}),n=b("textarea",{value:g,onChange:i=>e(i.currentTarget.value)}),o=b("button",{onClick:async()=>{const i=g.split(`
`);let j=new Map(a?a.contents.map((s,w)=>[s,w]):[]),m=a?i.filter(s=>!j.has(s)):i;const p=await fetch(R,{body:JSON.stringify({sentences:m}),headers:{"Content-Type":"application/json"},method:"POST"});if(p.ok){const s=[],w=[],G=await p.json();{let k=0;for(const r of i){const l=j.get(r);if(a&&l!==void 0)s.push(a.raws[l]),w.push(a.annotated[l]);else{const y=G[k];s.push(typeof y==="string"?void 0:{sha1:await ea(r,"sha-1"),text:r,hits:y.hits,furigana:y.furigana}),w.push(void 0),k++}}}const q=a?a.unique:new Date().toISOString();s.length===w.length&&w.length===i.length||console.error("Warning: unexpected length of lines vs raw analysis vs annotated analysis",{raws:s,annotated:w,contents:i});const x={name:f,unique:q,contents:i,raws:s,annotated:w,overrides:a?a.overrides:{}};if(a)for(const[k,r]of a.annotated.entries()){const l=x.raws[k],y=a.raws[k];if(!r||!l||!y||x.annotated[k])continue;const t={sha1:l.sha1,text:l.text,furigana:[],hits:[]},z=new Map();for(const A of r.furigana)A&&z.set(F(A),A);t.furigana=l.furigana.map(A=>z.get(F(A))||A);const M=l.furigana.map(F);for(const A of r.hits){const K=y.furigana.slice(A.startIdx,A.endIdx).map(F),H=fa(M,K);if(H>=0){const ja=ia(ha(M.slice(0,H).join(""),K.join(""),M.slice(H+K.length).join("")));t.hits.push({summary:A.summary,wordId:A.wordId,run:ja,startIdx:H,endIdx:H+K.length})}}x.annotated[k]=t}B.upsert(E(q),()=>x).then(()=>h(k=>({...k,[q]:x}))).then(()=>c?c():"")}else console.error("error parsing sentences: "+p.statusText)}},"Submit");return b("div",null,a?"":b("h2",null,"Create a new document"),u,b("br"),n,b("br"),o)}function $({}){const a=v.useRecoilValue(I),c=v.useSetRecoilState(C),f=v.useSetRecoilState(I);if(!a)return b("div",null);const{rawHits:d,annotations:g,lineNumber:e,docUnique:h,morphemeIdx:u}=a,n=new Set();if(g)for(const{wordId:i,run:j}of g.hits)n.add(i+J(j));function o(i,j,m,p){c(s=>{const w={...s},G=s[h];if(G){const q={...G};q.annotated=q.annotated.slice();const x=q.annotated[e];if(x){const k=J(j),r=x.hits.findIndex(l=>l.wordId===i.wordId&&J(l.run)===k);if(r>=0){const l=x.hits.slice();l.splice(r,1),q.annotated[e]={...x,hits:l}}else{const l={run:j,startIdx:m,endIdx:p,wordId:i.wordId,summary:i.summary};q.annotated[e]={...x,hits:x.hits.concat(l)}}}else{const k={run:j,startIdx:m,endIdx:p,wordId:i.wordId,summary:i.summary};q.annotated[e]={furigana:Array.from(Array(q.raws[e]?.furigana.length)),hits:[k],sha1:q.raws[e]?.sha1||"",text:q.raws[e]?.text||""}}w[h]=q,f(k=>k?{...k,annotations:q.annotated[e]}:k),B.upsert(E(h),()=>({...q}))}return w})}return b("div",null,...d.results.map(i=>b("ol",null,...i.results.map(j=>{const m=n.has(j.wordId+J(i.run));return b("li",{className:m?"annotated-entry":void 0},...aa(i.run,j.summary),b("button",{onClick:()=>o(j,i.run,d.startIdx,i.endIdx)},m?"Entry highlighted! Remove?":"Create highlight?"))}))),b(ba,{morpheme:a.morpheme,overrides:a.overrides,docUnique:h,lineNumber:e,morphemeIdx:u,key:`${h}${e}${u}`}))}function aa(a,c){const f=new Set((typeof a==="string"?a:a.cloze).split(""));return c.split("").map(d=>f.has(d)?b("span",{className:"highlighted"},d):d)}function ba({morpheme:a,overrides:c,docUnique:f,lineNumber:d,morphemeIdx:g}){const e=(a?.annotatedFurigana||a?.rawFurigana||[]).filter(k=>typeof k!=="string"),h=F(a?.annotatedFurigana||a?.rawFurigana||[]),u=v.useSetRecoilState(C),n=e.map(k=>k.rt),o=h in c,[i,j]=D(n),[m,p]=D(o);if(e.length===0||!a)return b(L);const s=i.map((k,r)=>b("input",{type:"text",value:k,onChange:l=>j(i.map((y,t)=>t===r?l.target.value:y))})),w=b("input",{type:"checkbox",name:"globalCheckbox",checked:m,onChange:()=>p(!m)}),G=b("label",{htmlFor:"globalCheckbox"},"Global override?"),q=b("button",{onClick:()=>{u(k=>{const r=[];{let t=0;for(const z of a.rawFurigana)r.push(typeof z==="string"?z:{ruby:z.ruby,rt:i[t++]})}const l=k[f],y=l?.raws[d];if(l&&y){const t={...l};if(m)t.overrides={...t.overrides,[h]:r};else{t.annotated=t.annotated.slice();const z=t.annotated[d]?{...t.annotated[d]}:{text:y.text,sha1:y.sha1,furigana:Array.from(Array(y.furigana.length)),hits:[]};z.furigana=z.furigana.slice(),z.furigana[g]=r,t.annotated[d]=z}return B.upsert(E(f),()=>({...t})),{...k,[f]:t}}return k})}},"Submit override"),x=b("button",{onClick:()=>{j(n),p(o)}},"Cancel");return b("div",null,b("h3",null,"Override for: "+h),b("ol",null,...e.map((k,r)=>b("li",null,k.ruby+" ",s[r]))),G,w,q)}function ca(){const a=v.useSetRecoilState(C),[c,f]=D([]),d=b("button",{onClick:()=>X().then(e=>f(e))},"Refresh deleted docs"),g=e=>B.upsert(e.unique,()=>e).then(()=>a(h=>({...h,[e.unique]:e})));return b("div",null,b("h2",null,"Deleted"),d,b("ol",null,...c.map(e=>b("li",null,`${e.name} (${e.unique}): ${e.contents.join(" ").slice(0,15)}…`,b("button",{onClick:()=>g(e)},"Undelete")))))}function da({overrides:a,docUnique:c}){const f=v.useSetRecoilState(C),d=Object.keys(a);return d.length===0?b(L):b("div",null,b("h3",null,"Overrides"),b("ol",null,...d.map(g=>{const e=()=>f(n=>{const o={...n[c]};return o.overrides={...o.overrides},delete o.overrides[g],B.upsert(E(c),()=>({...o})),{...n,[c]:o}}),h=a[g].map(n=>typeof n==="string"?n:b("ruby",null,n.ruby,b("rt",null,n.rt))),u=b("button",{onClick:e},"Delete");return b("li",null,`${g} → `,...h," ",u)})))}async function ea(a,c){const f=new TextEncoder().encode(a),d=await crypto.subtle.digest(c,f),g=Array.from(new Uint8Array(d)),e=g.map(h=>h.toString(16).padStart(2,"0")).join("");return e}function J(a){return typeof a==="string"?a:`${a.left}${a.cloze}${a.right}`}function F(a){return a.map(c=>typeof c==="string"?c:c.ruby).join("")}function fa(a,c,f=0){if(c.length>a.length)return-1;P:for(let d=f;d<a.length-c.length+1;d++){for(let g=0;g<c.length;g++)if(a[d+g]!==c[g])continue P;return d}return-1}function ga(a,c){const f=a.indexOf(c);return f>=0&&a.indexOf(c,f+1)<0}function ha(a,c,f){const d=a+c+f;let g="",e="",h=0;for(;!ga(d,g+c+e);){h++;if(h>a.length&&h>f.length)throw console.error({sentence:d,left:a,cloze:c,right:f,leftContext:g,rightContext:e,contextLength:h}),new Error("Ran out of context to build unique cloze");g=a.slice(-h),e=f.slice(0,h)}return{left:g,cloze:c,right:e}}function ia(a){return!a.right&&!a.left?a.cloze:a}
