import"./Docs.css.proxy.js";const le="https://curtiz-japanese-nlp.glitch.me/api/v1/sentences";import Y from"../web_modules/ebisu-js.js";var H;(function(t){t.kana2meaning="kana2meaning",t.kanji2kana="kanji2kana",t.any2kanji="any2kanji"})(H||(H={}));import D from"../web_modules/pouchdb-browser.js";import de from"../web_modules/pouchdb-upsert.js";D.plugin(de);const g=new D("sidecar-docs"),S=new D("sidecar-memories"),B="https://gotanda-1.glitch.me";S.changes({since:"now",live:!0,include_docs:!0}).on("change",N(t=>{if(he(t.id)&&!t.deleted){const e=t.doc;V.set(e.wordId,Object.keys(e.ebisus))}})),g.changes({since:"now",live:!0,include_docs:!0}).on("change",N(async t=>{if(_e(t.id))if(t.deleted){const e=Object.values(C).find(n=>q(n.unique)===t.id);e&&delete C[e.unique]}else{const e=t.doc,n=C[e.unique];if(n&&e.sha1s.every(s=>s in n.annotated))n.sha1s=e.sha1s,n.contents=e.contents,n.overrides=e.overrides,n.name=e.name;else{const s=(await Q(e.unique))[e.unique];J(()=>C[e.unique]=s)}}else if(!fe(t.id)){if(ne(t.id))if(t.deleted){const e=oe(t.id);if(e){const n=C[e.docUnique];n&&delete n.annotated[e.sha1]}}else{const e=t.doc,n=oe(t.id);if(n&&n.sha1===e.sha1){const s=C[n.docUnique];s&&(s.annotated[e.sha1]=e)}else{const s=Object.values(C).find(a=>t.id===j(a.unique,e.sha1));s&&(s.annotated[e.sha1]=e)}}}})),async function(){{const n=await fetch(`${B}/loginstatus`,{credentials:"include"});let s=n.ok?await n.text():void 0;if(J(()=>{Z.loggedIn=n.ok,s&&(Z.serverMessage=s)}),!n.ok)return}const e="kanda-mobx2";for(const[n,s]of[[g,e],[S,"kanda-memories"]]){const a=new D(`${B}/db/${s}`,{fetch:(i,r)=>(r||(r={}),r.credentials="include",D.fetch(i,r))});await n.replicate.from(a),n.sync(a,{live:!0,retry:!0})}{const n=await fetch(`${B}/me/onlookers`,{credentials:"include"});if(n.ok){const s=await n.json();for(const a of s.creators.filter(i=>i.app===e)){const i=new D(`${B}/creator/${a.creator}/app/${a.app}`,{fetch:(r,c)=>(c||(c={}),c.credentials="include",D.fetch(r,c))});await g.replicate.from(i),g.replicate.from(i,{live:!0,retry:!0})}}}}();function q(t){return`doc-${t}`}function O(t,e){return`docRaw-${t}-${typeof e=="string"?e:e.sha1}`}function j(t,e){return`docAnnotated-${t}-${typeof e=="string"?e:e.sha1}`}function G(t){return"memory-"+(typeof t=="string"?t:t.wordId)}function _e(t){return t.startsWith("doc-")}function fe(t){return t.startsWith("docRaw-")}function ne(t){return t.startsWith("docAnnotated-")}function he(t){return t.startsWith("memory-")}function oe(t){if(ne(t)){const e=t.match(/^docAnnotated-(.*)-([0-9a-fA-F]+)$/);if(e){const[,n,s]=e;if(n&&s)return{docUnique:n,sha1:s}}}return}async function Q(t=""){const e=q(t),n=await g.allDocs({startkey:e,endkey:e+"️",include_docs:!0}),s=await Promise.all(n.rows.flatMap(i=>{if(!i.doc)return[];const r=i.doc.unique,c=i.doc.sha1s;return g.allDocs({keys:c.map(d=>j(r,d)),include_docs:!0}).then(async d=>{const b={};for(const E of d.rows){const w=E.doc;if(w){if(w.furigana.length===0){g.upsert(E.id,X);continue}if(w.furigana.some(I=>!I)){const I=await g.get(O(r,w.sha1));w.furigana=w.furigana.map((U,f)=>U||I.furigana[f]),g.upsert(j(r,w.sha1),U=>({...U,furigana:w.furigana}))}b[w.sha1]=w}}return b})})),a={};for(const[i,{doc:r}]of n.rows.entries())if(r){const c={name:r.name,unique:r.unique,overrides:r.overrides,contents:r.contents,sha1s:r.sha1s,annotated:s[i]};a[r.unique]=c}return a}async function se(t){const e=G(""),n=await t.allDocs({startkey:e,endkey:e+"️",include_docs:!0}),s=[];for(const a of n.rows){const i=a.doc;i&&s.push(i)}return s}async function me(t,e=Date.now()){const n=G(""),s=await t.allDocs({startkey:n,endkey:n+"️",include_docs:!0});let a=0,i=Infinity,r;for(const c of s.rows){const d=c.doc;if(d){++a;for(const[b,E]of Object.entries(d.ebisus)){if(!E)continue;const w=Y.predictRecall(E.memory,(e-E.epoch)*ue);w<i&&(r={...d,ebisus:{[b]:E}},i=w)}}}return{memory:r,total:a}}async function pe(t){return g.upsert(q(t),X)}async function ge(){const t=[];return new Promise((e,n)=>{g.changes({filter:s=>s._deleted}).on("change",s=>t.push(s.id)).on("complete",()=>{e(t)}).on("error",s=>n(s))})}async function we(){const t=await ge(),e="No longer able to get deleted document. It may have been compacted during export?";let n=await Promise.all(t.map(a=>g.get(a,{revs:!0,open_revs:"all"}).then(i=>{const r=i[0].ok._revisions,c=r.start-1+"-"+r.ids[1],d=g.get(a,{rev:c});return d})).map(a=>a.catch(i=>(console.error(e,i),i))));n.some(a=>a instanceof Error)&&(alert(e+" See JavaScript Console for details."),n=n.filter(a=>!(a instanceof Error)));const s=n.map(({name:a,unique:i,contents:r,sha1s:c,overrides:d})=>({name:a,unique:i,contents:r,sha1s:c,overrides:d}));return s}import{observable as $,action as N,runInAction as J}from"../web_modules/mobx.js";const C=$({}),z=$({state:"left"}),V=$.map(new Map()),Z=$({loggedIn:void 0,serverMessage:void 0,debug:""}),W=$({click:void 0});(async function(){const[e,n]=await Promise.all([Q(),se(S)]);N(()=>{V.replace(n.map(s=>[s.wordId,Object.keys(s.ebisus)]));for(const[s,a]of Object.entries(e))C[s]=$(a)})()})();import{observer as A}from"../web_modules/mobx-react-lite.js";import{createElement as o,Fragment as K,Suspense as ye,useState as T}from"../web_modules/react.js";export const DocsComponent=A(function({}){return o("div",{},o(be),o(Pe),o("div",{id:"all-docs",className:"main"},o("ul",{},...Object.values(C).map(e=>o("li",null,o("a",{href:"#"+e.unique},e.name||e.unique)))),...Object.values(C).map(e=>o(Ee,{doc:e})),o(ae),o(xe),o(Ce)),o("div",{className:"not-main"},o(ye,{fallback:o("p",null,"Loading…")},o(ke))))});const be=A(function({}){const e=Z;return o("div",{className:"login-header"},typeof e.loggedIn=="boolean"?e.loggedIn?"Logged in!":o("a",{href:B},"Log in to Gotanda"):"(waiting)")}),Pe=A(function(){if(!z.payload){const n=o("button",{onClick:async()=>{const s=Date.now(),a=await me(S,s);J(()=>{z.payload={memory:a.memory,history:[]}})}},"Get quiz");return n}const e=z.payload.memory;if(e&&e.ebisus.kana2meaning){const[n,s]=e.summary.split("|"),a=i=>{S.upsert(G(e.wordId),N(r=>{if(!r)return!1;const c=r.ebisus;if(!c)return!1;const d=c.kana2meaning;if(!d)return!1;const b=Date.now();return c.kana2meaning={epoch:b,memory:Y.updateRecall(d.memory,+i,1,(b-d.epoch)*ue)},z.payload=void 0,r}))};return o("div",null,`Do you know what this means: ${n}`,o("button",{onClick:()=>a(!0)},"Yes!"),o("button",{onClick:()=>a(!1)},"No…"),o("button",{onClick:N(()=>z.payload=void 0)},"Cancel"),o("details",null,o("span",{className:"hidden-till-highlight"},s)))}return o("div",null,"Nothing to quiz!")}),Ee=A(function({doc:e}){const[n,s]=T(!1);if(!e)return o(K);const a=o("button",{onClick:()=>pe(e.unique)},"Delete"),i=o("button",{onClick:()=>s(!n)},n?"Cancel":"Edit"),r=n?o(ae,{old:e,done:()=>s(!n)}):o("section",null,...e.sha1s.map((c,d)=>o(Ue,{lineNumber:d,doc:e})));return o("div",{className:"doc"},o("h2",{id:e.unique},e.name||e.unique,a,i),r,o(Ie,{doc:e}),o(Re,{doc:e}))});function ae({old:t,done:e}){const[n,s]=T(t?t.name:""),[a,i]=T(t?t.contents.join(`
`):""),r=o("input",{type:"text",value:n,onChange:b=>s(b.target.value)}),c=o("textarea",{value:a,onChange:b=>i(b.currentTarget.value)}),d=o("button",{onClick:()=>ie(a.split(`
`),t).then(()=>e?e():null)},"Submit");return o("div",null,t?"":o("h2",null,"Create a new document"),r,o("br"),c,o("br"),d)}async function ie(t,e){const n=new Map(e?e.contents.map((i,r)=>[i,r]):[]),s=e?t.filter(i=>!n.has(i)):t,a=await ee(s);if(a){const i={},r={},c=[],d=new Map();let b=0;for(const[U,f]of t.entries()){const R=n.get(f);if(R!==void 0){const k=e?.sha1s[R]||"";c.push(k),r[k]=e?.annotated[R];continue}const m=a[b++],h=await Se(f,"sha-1");c.push(h),d.set(h,U),typeof m!="string"&&(i[h]={sha1:h,text:f,hits:m.hits,furigana:m.furigana,kanjidic:m.kanjidic},r[h]={sha1:h,text:f,hits:[],furigana:m.furigana.slice()})}if(c.length!==t.length&&console.error("Mismatch between lines and sha1s",{sha1s:c,newContents:t}),e){const U=new Set(c),f=new Set(e.sha1s.flatMap((v,u)=>U.has(v)?[]:u)),R=new Set(t.flatMap((v,u)=>n.has(v)?[]:u)),m=new Map(),h=new Map(),k=[];for(const v of f){const u=e.sha1s[v],l=e.annotated[u];let _;try{_=await g.get(O(e.unique,u))}catch{_=void 0}for(const[p,y]of(l?l.furigana:[]).entries())y&&(m.set(M(y),y),h.set(re(_?.furigana[p]||["<none>"]),y));for(const p of l?l.hits:[]){const y=(_?.furigana.slice(p.startIdx,p.endIdx)||[]).map(M);k.push({...p,furiganaBase:y,used:!1})}}for(const v of R){const u=r[c[v]],l=i[c[v]];if(u&&l){for(const[p,y]of l.furigana.entries()){const P=m.has(M(y))?h.get(re(y)):void 0;P&&(u.furigana[p]=P)}const _=l.furigana.map(M);for(const p of k)if(!p.used&&t[v].includes(Oe(p.run))){const y=p.furiganaBase,P=qe(_,y);if(P>=0){const x=Me(Te(_.slice(0,P).join(""),y.join(""),_.slice(P+y.length).join("")));u.hits.push({summary:p.summary,wordId:p.wordId,run:x,startIdx:P,endIdx:P+y.length}),p.used=!0}}}}}const E=e?e.unique:new Date().toISOString(),w={name,unique:E,contents:t,sha1s:c,overrides:e?e.overrides:{}};let I=[g.upsert(q(E),()=>w)];for(const U of d.keys())I.push(g.upsert(O(E,U),()=>i[U])),I.push(g.upsert(j(E,U),()=>r[U]))}else console.error("error parsing sentences")}const Re=A(function({doc:e}){return o("details",{className:"regular-sized limited-height"},o("summary",null,"All dictionary annotations"),o("ol",null,...e.sha1s.flatMap(n=>e.annotated[n]?.hits.map(s=>o("li",null,s.summary))||[])))}),Ue=A(function({lineNumber:e,doc:n}){const s=n.sha1s[e],a=n.annotated[s],i=n.contents[e],[r,c]=T(void 0);if(r!==void 0){const f=o("textarea",{value:r,onChange:h=>c(h.currentTarget.value)}),R=o("button",{onClick:()=>c(void 0)},"Cancel"),m=o("button",{onClick:()=>{const h=n.contents.slice();h.splice(e,1,...r.split(`
`)),ie(h,n).then(()=>c(void 0))}},"Submit");return o("div",null,o("h3",null,"Edit away!"),f,m,R)}const d=o("button",{onClick:()=>c(i)},"Edit");if(!a){const f=o("button",{onClick:async()=>{const m=await ee([i]);if(m&&typeof m[0]!="string"){const h=m[0];{const k={sha1:s,text:i,hits:h.hits,furigana:h.furigana,kanjidic:h.kanjidic};g.upsert(O(n.unique,s),()=>k)}{const k={sha1:s,text:i,hits:[],furigana:h.furigana.slice()};g.upsert(j(n.unique,s),()=>k)}}}},"Annotate"),R=o("details",{className:"trailing-details"},o("summary",null,"…"),f,d);return o("p",null,n.contents[e],i&&i!==`
`?R:"")}const{furigana:b}=a,E=new Set();if(a)for(const{startIdx:f,endIdx:R}of a.hits)for(let m=f;m<R;m++)E.add(m);const w=o("button",{onClick:()=>{g.upsert(j(n.unique,s),X),g.upsert(O(n.unique,s),X)}},"Discard annotations"),I=o("details",{className:"trailing-details"},o("summary",null,"…"),w,d),U=E.size>0?f=>E.has(f)?"annotated-text":void 0:()=>{};return o("p",{id:`${n.unique}-${e}`},...b.map(f=>f?n.overrides[M(f)]||f:["missing"]).flatMap((f,R)=>f.map(m=>{let h;const k=async()=>{try{h=await g.get(O(n.unique,s))}catch{const u=await ee([i]);u&&u[0]&&typeof u[0]!="string"?h={sha1:s,text:i,...u[0]}:h={sha1:s,text:i,hits:[],furigana:[]}}const v={doc:n,lineNumber:e,morphemeNumber:R,raw:h};J(()=>W.click=v)};return typeof m=="string"?o("span",{className:U(R),onClick:k},m):o("ruby",{className:U(R),onClick:k},m.ruby,o("rt",null,m.rt))})),I)}),ke=A(function({}){const e=W.click;if(!e)return o("div",null);const{doc:n,lineNumber:s,morphemeNumber:a,raw:i}=e,r=n.sha1s[s],c=n.annotated[r];if(!i||!c)return o("div",null);const d=n.unique,b=i.hits[a],E=new Set(c?.hits?.map(u=>u.wordId+F(u.run))),w=new Map();{const u=new Set(c?.hits?.map(l=>l.wordId));for(const[l,_]of n.sha1s.entries()){const p=n.annotated[_];if(p){const y=n.contents[l],P=p.hits.filter(x=>u.has(x.wordId));for(const{wordId:x}of P)w.set(x,(w.get(x)||[]).concat({sentence:y,lino:l}))}}}function I(u,l,_,p){g.upsert(j(d,r),y=>{const P=y?.hits;if(!y||!P)return!1;const x=F(l),te=P.findIndex(L=>L.wordId===u.wordId&&F(L.run)===x);if(te>=0){const L=P.splice(te,1)}else{const L={run:l,startIdx:_,endIdx:p,wordId:u.wordId,summary:u.summary};P.push(L)}return y})}const U=i.furigana[a],f=i.kanjidic||{},R=M(U).split("").filter(u=>u in f).map(u=>f[u]),m=R.length?o("div",null,o("h3",null,"Kanjidic"),o("ol",null,...R.map(u=>o("li",null,summarizeCharacter(u),u.dependencies?.length?o("ul",null,...u.dependencies.map(l=>o("li",null,l.nodeMapped?summarizeCharacter(l.nodeMapped):l.node))):void 0)))):"",h=new Set(b.results.flatMap(u=>u.results.map(l=>l.wordId))),k=c?.hits?.filter(u=>h.has(u.wordId))||[],v=k.length?o("div",null,o("h3",null,"All uses"),o("ul",null,...k.map(u=>o("li",null,u.summary,o("ol",null,...(w.get(u.wordId)||[]).map(({sentence:l,lino:_})=>o("li",null,o("a",{href:`#${d}-${_}`},je(u.run,l))))))))):"";return o("div",null,o("button",{onClick:N(()=>W.click=void 0)},"close"),...b.results.map(u=>o("ol",null,...u.results.map(l=>{const _=E.has(l.wordId+F(u.run)),p=V.get(l.wordId)||[],y=_?[o("button",{onClick:()=>{S.upsert(G(l.wordId),P=>{if(!P.wordId)return{wordId:l.wordId,memoryType:"jmdictWordId",summary:l.summary,ebisus:{[H.kana2meaning]:ce()}};const x=P.ebisus||{};return x.kana2meaning?delete x.kana2meaning:x.kana2meaning=ce(),P.ebisus=x,P})}},p.includes(H.kana2meaning)?"Unlearn kana?":"Mark kana as learned!")]:[];return o("li",{className:_?"annotated-entry":void 0},...De(u.run,l.summary),o("button",{onClick:()=>I(l,u.run,b.startIdx,u.endIdx)},_?"Entry highlighted! Remove?":"Create highlight?"),...y)}))),m,v,o(ve,{key:`${n.unique}${s}${a}`}))});function ve({}){const t=W.click;if(!t)return o(K);const{doc:e,lineNumber:n,morphemeNumber:s,raw:a}=t,i=a?.furigana[s]||[],r=e.annotated[e.sha1s[n]]?.furigana[s]||i,c=M(r),d=e.overrides[c]||r,b=d.filter(l=>typeof l!="string"),E=b.map(l=>l.rt),w=c in e.overrides,[I,U]=T(E),[f,R]=T(w);if(b.length===0)return o(K);const m=I.map((l,_)=>o("input",{type:"text",value:l,onChange:p=>U(I.map((y,P)=>P===_?p.target.value:y))})),h=o("input",{type:"checkbox",name:"globalCheckbox",checked:f,onChange:()=>R(!f)}),k=o("label",{htmlFor:"globalCheckbox"},"Global override?"),v=o("button",{onClick:()=>{const l=[];{let _=0;for(const p of i)l.push(typeof p=="string"?p:{ruby:p.ruby,rt:I[_++]})}f?g.upsert(q(e.unique),_=>(_.overrides={..._.overrides,[c]:l},_)):g.upsert(j(e.unique,e.sha1s[n]),_=>(_.furigana&&(_.furigana[s]=l),_))}},"Submit override"),u=o("button",{onClick:()=>{U(E),R(w)}},"Cancel");return o("div",null,o("h3",null,"Override for: "+c),o("ol",null,...b.map((l,_)=>o("li",null,l.ruby+" ",m[_]))),k,h,v)}function Ie({doc:t}){const e=t.overrides,n=Object.keys(e);return n.length===0?o(K):o("div",null,o("h3",null,"Overrides"),o("ol",null,...n.map(s=>{const a=()=>{g.upsert(q(t.unique),c=>{const d=c.overrides||{};return delete d[s],c.overrides=d,c})},i=e[s].map(c=>typeof c=="string"?c:o("ruby",null,c.ruby,o("rt",null,c.rt))),r=o("button",{onClick:a},"Delete");return o("li",null,`${s} → `,...i," ",r)})))}function xe(){const[t,e]=T([]),n=o("button",{onClick:()=>we().then(a=>e(a))},"Refresh deleted docs"),s=a=>g.upsert(q(a.unique),()=>a);return o("div",null,o("h2",null,"Deleted"),n,o("ol",null,...t.map(a=>o("li",null,`${a.name} (${a.unique}): ${a.contents.join(" ").slice(0,15)}…`,o("button",{onClick:()=>s(a)},"Undelete")))))}function Ce(){return o("button",{onClick:async()=>{const t=await Q(),e=await se(S),n=new Blob([JSON.stringify({docs:t,memories:e})],{type:"application/json"}),s=document.createElement("a");s.href=URL.createObjectURL(n),s.download=`kanda-${new Date().toISOString().replace(/:/g,".")}.json`,document.body.appendChild(s),s.click()}},"Export")}function je(t,e){const n=F(t),s=e.indexOf(n);return s<0?e:"…"+e.slice(Math.max(0,s-5),s+n.length+5)+"…"}function De(t,e){const n=new Set((typeof t=="string"?t:t.cloze).split(""));return e.split("").map(s=>n.has(s)?o("span",{className:"highlighted"},s):s)}export function summarizeCharacter(t){const{literal:e,readings:n,meanings:s,nanori:a}=t;return`${e}： ${n.join(", ")} ${s.join("; ")}`+(a.length?` (names: ${a.join(", ")})`:"")}async function Se(t,e){const n=new TextEncoder().encode(t),s=await crypto.subtle.digest(e,n);return Array.from(new Uint8Array(s),a=>a.toString(16).padStart(2,"0")).join("")}function F(t){return typeof t=="string"?t:`${t.left}${t.cloze}${t.right}`}function M(t){return t.map(e=>typeof e=="string"?e:e.ruby).join("")}function re(t){return t.map(e=>typeof e=="string"?e:e.rt).join("")}function qe(t,e,n=0){if(e.length>t.length)return-1;e:for(let s=n;s<t.length-e.length+1;s++){for(let a=0;a<e.length;a++)if(t[s+a]!==e[a])continue e;return s}return-1}function Ae(t,e){const n=t.indexOf(e);return n>=0&&t.indexOf(e,n+1)<0}function Te(t,e,n){const s=t+e+n;let a="",i="",r=0;for(;!Ae(s,a+e+i);){if(r++,r>t.length&&r>n.length)throw console.error({sentence:s,left:t,cloze:e,right:n,leftContext:a,rightContext:i,contextLength:r}),new Error("Ran out of context to build unique cloze");a=t.slice(-r),i=n.slice(0,r)}return{left:a,cloze:e,right:i}}function Me(t){return!t.right&&!t.left?t.cloze:t}function Oe(t){return typeof t=="string"?t:t.cloze}function ce(t=Date.now()){return{epoch:t,memory:Y.defaultModel(1,2.5)}}const ue=1/36e5;async function ee(t){const e=await fetch(le,{body:JSON.stringify({sentences:t}),headers:{"Content-Type":"application/json"},method:"POST"});return e.ok?await e.json():void 0}const X=()=>({_deleted:!0});
