import"./Docs.css.proxy.js";import{createElement as e,Fragment as z,useEffect as B,useState as I}from"../web_modules/react.js";import E from"../web_modules/recoil.js";const L="https://curtiz-japanese-nlp.glitch.me/api/v1/sentences",j=E.atom({key:"docs",default:{}}),q=E.selectorFamily({key:"doc",get:t=>({get:n})=>n(j)[t]}),$=E.atom({key:"clickedMorpheme",default:void 0});import F from"../web_modules/pouchdb-browser.js";import G from"../web_modules/pouchdb-upsert.js";F.plugin(G);const x=new F("sidecar-docs");function A(t){return`doc-${t}`}async function V(){const t=A(""),n=await x.allDocs({startkey:t,endkey:t+"️",include_docs:!0}),a={};for(const{doc:o}of n.rows)if(o){const r={name:o.name,unique:o.unique,contents:o.contents,raws:o.raws,annotated:o.annotated,overrides:o.overrides};a[o.unique]=r}return a}async function J(t){return x.upsert(A(t),()=>({_deleted:!0}))}async function K(){const t=[];return new Promise((n,a)=>{x.changes({filter:o=>o._deleted}).on("change",o=>t.push(o.id)).on("complete",()=>{n(t)}).on("error",o=>a(o))})}async function W(){const t=await K(),n=await Promise.all(t.map(o=>x.get(o,{revs:!0,open_revs:"all"}).then(r=>{const s=r[0].ok._revisions,i=s.start-1+"-"+s.ids[1],R=x.get(o,{rev:i});return R}))),a=n.map(({name:o,unique:r,contents:s,raws:i,annotated:R,overrides:p})=>({name:o,unique:r,contents:s,raws:i,annotated:R,overrides:p}));return a}export function DocsComponent({}){const[t,n]=E.useRecoilState(j),[a,o]=I(!1);B(()=>{a||(async()=>{const i=await V();Object.keys(i).length>0&&n(i),o(!0)})()},[a]);const r=e("div",{id:"all-docs",className:"left-containee"},...Object.keys(t).map(i=>e(Q,{unique:i})),e(H),e(nt)),s=e("div",{className:"right-containee"},e(Z));return e("div",{className:"container"},r,s)}function Q({unique:t}){const n=E.useRecoilValue(q(t)),a=E.useSetRecoilState(j),o=E.useSetRecoilState($),[r,s]=I(!1);if(!n)return e(z);const i=e("button",{onClick:()=>J(t).then(()=>a(u=>{const h={...u};return delete h[t],h}))},"Delete"),R=e("button",{onClick:()=>s(!r)},r?"Cancel":"Edit"),p=n.overrides,g=r?e(H,{existing:n,done:()=>s(!r)}):e("section",null,...n.raws.map((u,h)=>u?e(Y,{rawAnalysis:u,annotated:n.annotated[h],docUnique:t,lineNumber:h,overrides:p}):e("p",{onClick:()=>o(void 0)},n.contents[h])));return e("div",{className:"doc"},e("h2",null,n.name||t,i,R),g,e(ot,{overrides:n.overrides,docUnique:t}),e(X,{doc:n}))}function X({doc:t}){return e("details",{className:"regular-sized limited-height"},e("summary",null,"All dictionary annotations"),e("ol",null,...t.annotated.flatMap(n=>n?.hits.map(a=>e("li",null,a.summary))).filter(n=>!!n)))}function Y({rawAnalysis:t,docUnique:n,lineNumber:a,annotated:o,overrides:r}){const s=E.useSetRecoilState($),{furigana:i,hits:R}=t,p={docUnique:n,lineNumber:a,annotations:o,overrides:r},g=new Set();if(o)for(const{startIdx:h,endIdx:y}of o.hits)for(let b=h;b<y;b++)g.add(b);const u=g.size>0?h=>g.has(h)?"annotated-text":void 0:()=>{};return e("p",null,...i.map((h,y)=>o?.furigana[y]||r[D(h)]||h).flatMap((h,y)=>h.map(b=>{const l={...p,rawHits:R[y],morpheme:{rawFurigana:t.furigana[y],annotatedFurigana:o?.furigana[y]},morphemeIdx:y,kanjidic:t.kanjidic||{}};return typeof b=="string"?e("span",{className:u(y),onClick:()=>s(l)},b):e("ruby",{className:u(y),onClick:()=>s(l)},b.ruby,e("rt",null,b.rt))})))}function H({existing:t,done:n}){const[a,o]=I(t?t.name:""),[r,s]=I(t?t.contents.join(`
`):""),i=E.useSetRecoilState(j),R=e("input",{type:"text",value:a,onChange:u=>o(u.target.value)}),p=e("textarea",{value:r,onChange:u=>s(u.currentTarget.value)}),g=e("button",{onClick:async()=>{const u=r.split(`
`);let h=new Map(t?t.contents.map((l,m)=>[l,m]):[]),y=t?u.filter(l=>!h.has(l)):u;const b=await fetch(L,{body:JSON.stringify({sentences:y}),headers:{"Content-Type":"application/json"},method:"POST"});if(b.ok){const l=[],m=[],k=await b.json();{let d=0;for(const w of u){const c=h.get(w);if(t&&c!==void 0)l.push(t.raws[c]),m.push(t.annotated[c]);else{const f=k[d];l.push(typeof f=="string"?void 0:{sha1:await st(w,"sha-1"),text:w,hits:f.hits,furigana:f.furigana,kanjidic:f.kanjidic}),m.push(void 0),d++}}}const S=t?t.unique:new Date().toISOString();l.length===m.length&&m.length===u.length||console.error("Warning: unexpected length of lines vs raw analysis vs annotated analysis",{raws:l,annotated:m,contents:u});const C={name:a,unique:S,contents:u,raws:l,annotated:m,overrides:t?t.overrides:{}};if(t)for(const[d,w]of t.annotated.entries()){const c=C.raws[d],f=t.raws[d];if(!w||!c||!f||C.annotated[d])continue;const _={sha1:c.sha1,text:c.text,furigana:[],hits:[]},P=new Map();for(const v of w.furigana)v&&P.set(D(v),v);_.furigana=c.furigana.map(v=>P.get(D(v))||v);const U=c.furigana.map(D);for(const v of w.hits){const T=f.furigana.slice(v.startIdx,v.endIdx).map(D),O=at(U,T);if(O>=0){const M=lt(it(U.slice(0,O).join(""),T.join(""),U.slice(O+T.length).join("")));_.hits.push({summary:v.summary,wordId:v.wordId,run:M,startIdx:O,endIdx:O+T.length})}}C.annotated[d]=_}x.upsert(A(S),()=>C).then(()=>i(d=>({...d,[S]:C}))).then(()=>n?n():"")}else console.error("error parsing sentences: "+b.statusText)}},"Submit");return e("div",null,t?"":e("h2",null,"Create a new document"),R,e("br"),p,e("br"),g)}function Z({}){const t=E.useRecoilValue($),n=E.useSetRecoilState(j),a=E.useSetRecoilState($);if(!t)return e("div",null);const{rawHits:o,annotations:r,lineNumber:s,docUnique:i,morphemeIdx:R,morpheme:{rawFurigana:p},kanjidic:g}=t,u=new Set();if(r)for(const{wordId:l,run:m}of r.hits)u.add(l+N(m));function h(l,m,k,S){n(C=>{const d={...C},w=C[i];if(w){const c={...w};c.annotated=c.annotated.slice();const f=c.annotated[s];if(f){const _=N(m),P=f.hits.findIndex(U=>U.wordId===l.wordId&&N(U.run)===_);if(P>=0){const U=f.hits.slice();U.splice(P,1),c.annotated[s]={...f,hits:U}}else{const U={run:m,startIdx:k,endIdx:S,wordId:l.wordId,summary:l.summary};c.annotated[s]={...f,hits:f.hits.concat(U)}}}else{const _={run:m,startIdx:k,endIdx:S,wordId:l.wordId,summary:l.summary};c.annotated[s]={furigana:Array.from(Array(c.raws[s]?.furigana.length)),hits:[_],sha1:c.raws[s]?.sha1||"",text:c.raws[s]?.text||""}}d[i]=c,a(_=>_&&{..._,annotations:c.annotated[s]}),x.upsert(A(i),()=>({...c}))}return d})}const y=D(p).split("").filter(l=>l in g).map(l=>g[l]),b=y.length?e("div",null,e("h3",null,"Kanjidic"),e("ol",null,y.map(l=>e("li",null,summarizeCharacter(l))))):"";return e("div",null,...o.results.map(l=>e("ol",null,...l.results.map(m=>{const k=u.has(m.wordId+N(l.run));return e("li",{className:k?"annotated-entry":void 0},...tt(l.run,m.summary),e("button",{onClick:()=>h(m,l.run,o.startIdx,l.endIdx)},k?"Entry highlighted! Remove?":"Create highlight?"))}))),e(et,{morpheme:t.morpheme,overrides:t.overrides,docUnique:i,lineNumber:s,morphemeIdx:R,key:`${i}${s}${R}`}),b)}function tt(t,n){const a=new Set((typeof t=="string"?t:t.cloze).split(""));return n.split("").map(o=>a.has(o)?e("span",{className:"highlighted"},o):o)}export function summarizeCharacter(t){const{literal:n,readings:a,meanings:o,nanori:r}=t;return`${n} ${a.join("；")} - ${o.join("；")}`+(r.length?` (names: ${r.join("；")})`:"")}function et({morpheme:t,overrides:n,docUnique:a,lineNumber:o,morphemeIdx:r}){const s=(t?.annotatedFurigana||t?.rawFurigana||[]).filter(d=>typeof d!="string"),i=D(t?.annotatedFurigana||t?.rawFurigana||[]),R=E.useSetRecoilState(j),p=s.map(d=>d.rt),g=i in n,[u,h]=I(p),[y,b]=I(g);if(s.length===0||!t)return e(z);const l=u.map((d,w)=>e("input",{type:"text",value:d,onChange:c=>h(u.map((f,_)=>_===w?c.target.value:f))})),m=e("input",{type:"checkbox",name:"globalCheckbox",checked:y,onChange:()=>b(!y)}),k=e("label",{htmlFor:"globalCheckbox"},"Global override?"),S=e("button",{onClick:()=>{R(d=>{const w=[];{let _=0;for(const P of t.rawFurigana)w.push(typeof P=="string"?P:{ruby:P.ruby,rt:u[_++]})}const c=d[a],f=c?.raws[o];if(c&&f){const _={...c};if(y)_.overrides={..._.overrides,[i]:w};else{_.annotated=_.annotated.slice();const P=_.annotated[o]?{..._.annotated[o]}:{text:f.text,sha1:f.sha1,furigana:Array.from(Array(f.furigana.length)),hits:[]};P.furigana=P.furigana.slice(),P.furigana[r]=w,_.annotated[o]=P}return x.upsert(A(a),()=>({..._})),{...d,[a]:_}}return d})}},"Submit override"),C=e("button",{onClick:()=>{h(p),b(g)}},"Cancel");return e("div",null,e("h3",null,"Override for: "+i),e("ol",null,...s.map((d,w)=>e("li",null,d.ruby+" ",l[w]))),k,m,S)}function nt(){const t=E.useSetRecoilState(j),[n,a]=I([]),o=e("button",{onClick:()=>W().then(s=>a(s))},"Refresh deleted docs"),r=s=>x.upsert(s.unique,()=>s).then(()=>t(i=>({...i,[s.unique]:s})));return e("div",null,e("h2",null,"Deleted"),o,e("ol",null,...n.map(s=>e("li",null,`${s.name} (${s.unique}): ${s.contents.join(" ").slice(0,15)}…`,e("button",{onClick:()=>r(s)},"Undelete")))))}function ot({overrides:t,docUnique:n}){const a=E.useSetRecoilState(j),o=Object.keys(t);return o.length===0?e(z):e("div",null,e("h3",null,"Overrides"),e("ol",null,...o.map(r=>{const s=()=>a(p=>{const g={...p[n]};return g.overrides={...g.overrides},delete g.overrides[r],x.upsert(A(n),()=>({...g})),{...p,[n]:g}}),i=t[r].map(p=>typeof p=="string"?p:e("ruby",null,p.ruby,e("rt",null,p.rt))),R=e("button",{onClick:s},"Delete");return e("li",null,`${r} → `,...i," ",R)})))}async function st(t,n){const a=new TextEncoder().encode(t),o=await crypto.subtle.digest(n,a),r=Array.from(new Uint8Array(o)),s=r.map(i=>i.toString(16).padStart(2,"0")).join("");return s}function N(t){return typeof t=="string"?t:`${t.left}${t.cloze}${t.right}`}function D(t){return t.map(n=>typeof n=="string"?n:n.ruby).join("")}function at(t,n,a=0){if(n.length>t.length)return-1;t:for(let o=a;o<t.length-n.length+1;o++){for(let r=0;r<n.length;r++)if(t[o+r]!==n[r])continue t;return o}return-1}function rt(t,n){const a=t.indexOf(n);return a>=0&&t.indexOf(n,a+1)<0}function it(t,n,a){const o=t+n+a;let r="",s="",i=0;for(;!rt(o,r+n+s);){if(i++,i>t.length&&i>a.length)throw console.error({sentence:o,left:t,cloze:n,right:a,leftContext:r,rightContext:s,contextLength:i}),new Error("Ran out of context to build unique cloze");r=t.slice(-i),s=a.slice(0,i)}return{left:r,cloze:n,right:s}}function lt(t){return!t.right&&!t.left?t.cloze:t}
