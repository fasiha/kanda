import"./Docs.css.proxy.js";const de="https://curtiz-japanese-nlp.glitch.me/api/v1/sentences";import Z from"../web_modules/ebisu-js.js";var X;(function(n){n.kana2meaning="kana2meaning",n.kanji2kana="kanji2kana",n.any2kanji="any2kanji"})(X||(X={}));import F from"../web_modules/pouchdb-browser.js";import _e from"../web_modules/pouchdb-upsert.js";F.plugin(_e);const y=new F("sidecar-docs"),M=new F("sidecar-memories");M.changes({since:"now",live:!0,include_docs:!0}).on("change",T(n=>{if(pe(n.id)&&!n.deleted){const e=n.doc;te.set(e.wordId,Object.keys(e.ebisus))}})),y.changes({since:"now",live:!0,include_docs:!0}).on("change",T(async n=>{if(fe(n.id))if(n.deleted){const e=Object.values(D).find(o=>O(o.unique)===n.id);e&&delete D[e.unique]}else{const e=n.doc,o=D[e.unique];o&&e.sha1s.every(s=>s in o.raws)?(o.sha1s=e.sha1s,o.contents=e.contents,o.overrides=e.overrides,o.name=e.name):D[e.unique]=(await ne(e.unique))[e.unique]}else if(he(n.id)){const e=n.doc,o=Object.values(D).find(s=>n.id===ee(s.unique,e.sha1));o&&(o.raws[e.sha1]=e)}else if(me(n.id)){const e=n.doc,o=Object.values(D).find(s=>n.id===W(s.unique,e.sha1));o&&(o.annotated[e.sha1]=e)}})),async function(){const e="https://gotanda-1.glitch.me";{const s=await fetch(`${e}/loginstatus`,{credentials:"include"});let a=s.ok?await s.text():void 0;ae(()=>{oe.loggedIn=s.ok,a&&(oe.serverMessage=a)})}for(const[s,a]of[[y,"kanda-mobx2"],[M,"kanda-memories"]]){var o=new F(`${e}/db/${a}`,{fetch:(u,r)=>(r||(r={}),r.credentials="include",F.fetch(u,r))});await s.replicate.from(o),s.sync(o,{live:!0,retry:!0})}}();function O(n){return`doc-${n}`}function ee(n,e){return`docRaw-${n}-${typeof e=="string"?e:e.sha1}`}function W(n,e){return`docAnnotated-${n}-${typeof e=="string"?e:e.sha1}`}function Q(n){return"memory-"+(typeof n=="string"?n:n.wordId)}function fe(n){return n.startsWith("doc-")}function he(n){return n.startsWith("docRaw-")}function me(n){return n.startsWith("docAnnotated-")}function pe(n){return n.startsWith("memory-")}async function ne(n=""){const e=O(n),o=await y.allDocs({startkey:e,endkey:e+"️",include_docs:!0}),s=await Promise.all(o.rows.flatMap(r=>{if(!r.doc)return[];const c=r.doc.unique,d=r.doc.sha1s;return y.allDocs({keys:d.map(l=>ee(c,l)),include_docs:!0}).then(l=>{const f={};for(const h of l.rows)h.doc&&(f[h.doc.sha1]=h.doc);return f})})),a=await Promise.all(o.rows.flatMap(r=>{if(!r.doc)return[];const c=r.doc.unique,d=r.doc.sha1s;return y.allDocs({keys:d.map(l=>W(c,l)),include_docs:!0}).then(l=>{const f={};for(const h of l.rows)h.doc&&(f[h.doc.sha1]=h.doc);return f})})),u={};for(const[r,{doc:c}]of o.rows.entries())if(c){const d={name:c.name,unique:c.unique,overrides:c.overrides,contents:c.contents,sha1s:c.sha1s,raws:s[r],annotated:a[r]};u[c.unique]=d}return u}async function se(n){const e=Q(""),o=await n.allDocs({startkey:e,endkey:e+"️",include_docs:!0}),s=[];for(const a of o.rows){const u=a.doc;u&&s.push(u)}return s}async function ge(n,e=Date.now()){const o=Q(""),s=await n.allDocs({startkey:o,endkey:o+"️",include_docs:!0});let a=0,u=Infinity,r;for(const c of s.rows){const d=c.doc;if(d){++a;for(const[l,f]of Object.entries(d.ebisus)){if(!f)continue;const h=Z.predictRecall(f.memory,(e-f.epoch)*ue);h<u&&(r={...d,ebisus:{[l]:f}},u=h)}}}return{memory:r,total:a}}async function we(n){return y.upsert(O(n),()=>({_deleted:!0}))}async function ye(){const n=[];return new Promise((e,o)=>{y.changes({filter:s=>s._deleted}).on("change",s=>n.push(s.id)).on("complete",()=>{e(n)}).on("error",s=>o(s))})}async function be(){const n=await ye(),e="No longer able to get deleted document. It may have been compacted during export?";let o=await Promise.all(n.map(a=>y.get(a,{revs:!0,open_revs:"all"}).then(u=>{const r=u[0].ok._revisions,c=r.start-1+"-"+r.ids[1],d=y.get(a,{rev:c});return d})).map(a=>a.catch(u=>(console.error(e,u),u))));o.some(a=>a instanceof Error)&&(alert(e+" See JavaScript Console for details."),o=o.filter(a=>!(a instanceof Error)));const s=o.map(({name:a,unique:u,contents:r,sha1s:c,overrides:d})=>({name:a,unique:u,contents:r,sha1s:c,overrides:d}));return s}import{observable as L,action as T,runInAction as ae}from"../web_modules/mobx.js";const D=L({}),G=L({state:"left"}),te=L.map(new Map()),oe=L({loggedIn:void 0,serverMessage:void 0,debug:""}),J=L({click:void 0});(async function(){const[e,o]=await Promise.all([ne(),se(M)]);T(()=>{te.replace(o.map(s=>[s.wordId,Object.keys(s.ebisus)]));for(const[s,a]of Object.entries(e))D[s]=L(a,{raws:!1})})()})();import{observer as A}from"../web_modules/mobx-react-lite.js";import{createElement as t,Fragment as V,Suspense as Pe,useState as z}from"../web_modules/react.js";export const DocsComponent=A(function({}){return t("div",{},t(Re),t(Ee),t("div",{id:"all-docs",className:"main"},t("ul",{},...Object.values(D).map(e=>t("li",null,t("a",{href:"#"+e.unique},e.name||e.unique)))),...Object.values(D).map(e=>t(Ue,{doc:e})),t(re),t(je),t(Se)),t("div",{className:"not-main"},t(Pe,{fallback:t("p",null,"Loading…")},t(Ie))))});const Re=A(function({}){const e=oe;return t("div",{className:"login-header"},typeof e.loggedIn=="boolean"?e.loggedIn?"Logged in!":t("a",{href:"https://gotanda-1.glitch.me/"},"Log in to Gotanda"):"(waiting)")}),Ee=A(function(){if(!G.payload){const o=t("button",{onClick:async()=>{const s=Date.now(),a=await ge(M,s);ae(()=>{G.payload={memory:a.memory,history:[]}})}},"Get quiz");return o}const e=G.payload.memory;if(e&&e.ebisus.kana2meaning){const[o,s]=e.summary.split("|"),a=u=>{M.upsert(Q(e.wordId),T(r=>{if(!r)return!1;const c=r.ebisus;if(!c)return!1;const d=c.kana2meaning;if(!d)return!1;const l=Date.now();return c.kana2meaning={epoch:l,memory:Z.updateRecall(d.memory,+u,1,(l-d.epoch)*ue)},G.payload=void 0,r}))};return t("div",null,`Do you know what this means: ${o}`,t("button",{onClick:()=>a(!0)},"Yes!"),t("button",{onClick:()=>a(!1)},"No…"),t("button",{onClick:T(()=>G.payload=void 0)},"Cancel"),t("details",null,t("span",{className:"hidden-till-highlight"},s)))}return t("div",null,"Nothing to quiz!")}),Ue=A(function({doc:e}){const[o,s]=z(!1);if(!e)return t(V);const a=t("button",{onClick:()=>we(e.unique)},"Delete"),u=t("button",{onClick:()=>s(!o)},o?"Cancel":"Edit"),r=o?t(re,{old:e,done:()=>s(!o)}):t("section",null,...e.sha1s.map((c,d)=>t(ve,{lineNumber:d,doc:e})));return t("div",{className:"doc"},t("h2",{id:e.unique},e.name||e.unique,a,u),r,t(xe,{doc:e}),t(ke,{doc:e}))});function re({old:n,done:e}){const[o,s]=z(n?n.name:""),[a,u]=z(n?n.contents.join(`
`):""),r=t("input",{type:"text",value:o,onChange:l=>s(l.target.value)}),c=t("textarea",{value:a,onChange:l=>u(l.currentTarget.value)}),d=t("button",{onClick:async()=>{const l=a.split(`
`),f=new Map(n?n.contents.map((I,k)=>[I,k]):[]),h=n?l.filter(I=>!f.has(I)):l,C=await fetch(de,{body:JSON.stringify({sentences:h}),headers:{"Content-Type":"application/json"},method:"POST"});if(C.ok){const I=await C.json(),k={},x={},U=[],N=new Map();let B=0;for(const[p,P]of l.entries()){const E=f.get(P);if(E!==void 0){const j=n?.sha1s[E]||"";U.push(j),k[j]=n?.raws[E],x[j]=n?.annotated[E];continue}const g=I[B++],m=await Te(P,"sha-1");U.push(m),N.set(m,p),typeof g!="string"&&(k[m]={sha1:m,text:P,hits:g.hits,furigana:g.furigana,kanjidic:g.kanjidic},x[m]={sha1:m,text:P,hits:[],furigana:Array.from(Array(g.furigana.length))})}if(U.length!==l.length&&console.error("Mismatch between lines and sha1s",{sha1s:U,newContents:l}),n){const p=new Set(U),P=new Set(n.sha1s.flatMap((R,v)=>p.has(R)?[]:v)),E=new Set(l.flatMap((R,v)=>f.has(R)?[]:v)),g=new Map(),m=new Map(),j=[];for(const R of P){const v=n.sha1s[R],q=n.annotated[v];for(const[S,b]of(q?q.furigana:[]).entries())b&&(g.set($(b),b),m.set(ie(n.raws[v]?.furigana[S]||[]),b));for(const S of q?q.hits:[]){const b=(n.raws[v]?.furigana.slice(S.startIdx,S.endIdx)||[]).map($);j.push({...S,furiganaBase:b,used:!1})}}for(const R of E){const v=x[U[R]],q=k[U[R]];if(v&&q){v.furigana=q.furigana.map(b=>g.get($(b))&&m.get(ie(b))||void 0);const S=q.furigana.map($);for(const b of j)if(!b.used&&l[R].includes(Ne(b.run))){const Y=b.furiganaBase,H=Me(S,Y);if(H>=0){const le=$e(Ae(S.slice(0,H).join(""),Y.join(""),S.slice(H+Y.length).join("")));v.hits.push({summary:b.summary,wordId:b.wordId,run:le,startIdx:H,endIdx:H+Y.length}),b.used=!0}}}}}const w=n?n.unique:new Date().toISOString(),i={name:o,unique:w,contents:l,sha1s:U,overrides:n?n.overrides:{}};let _=[y.upsert(O(w),()=>i)];for(const p of N.keys())_.push(y.upsert(ee(w,p),()=>k[p])),_.push(y.upsert(W(w,p),()=>x[p]));Promise.all(_).then(()=>{e&&e()})}else console.error("error parsing sentences: "+C.statusText)}},"Submit");return t("div",null,n?"":t("h2",null,"Create a new document"),r,t("br"),c,t("br"),d)}const ke=A(function({doc:e}){return t("details",{className:"regular-sized limited-height"},t("summary",null,"All dictionary annotations"),t("ol",null,...e.sha1s.flatMap(o=>e.annotated[o]?.hits.map(s=>t("li",null,s.summary))||[])))}),ve=A(function({lineNumber:e,doc:o}){const s=o.raws[o.sha1s[e]],a=o.annotated[o.sha1s[e]];if(!s||!a)return t("p",null,o.contents[e]);const{furigana:u}=s,r=new Set();if(a)for(const{startIdx:d,endIdx:l}of a.hits)for(let f=d;f<l;f++)r.add(f);const c=r.size>0?d=>r.has(d)?"annotated-text":void 0:()=>{};return t("p",{id:`${o.unique}-${e}`},...u.map((d,l)=>a?.furigana[l]||o.overrides[$(d)]||d).flatMap((d,l)=>d.map(f=>{const h={doc:o,lineNumber:e,morphemeNumber:l};return typeof f=="string"?t("span",{className:c(l),onClick:T("clicked string",()=>J.click=h)},f):t("ruby",{className:c(l),onClick:T("clicked parsed",()=>J.click=h)},f.ruby,t("rt",null,f.rt))})))}),Ie=A(function({}){const e=J.click;if(!e)return t("div",null);const{doc:o,lineNumber:s,morphemeNumber:a}=e,u=o.raws[o.sha1s[s]],r=o.annotated[o.sha1s[s]];if(!u||!r)return t("div",null);const c=o.unique,d=o.sha1s[s],l=u.hits[a],f=new Set(r?.hits?.map(i=>i.wordId+K(i.run))),h=new Map();{const i=new Set(r?.hits?.map(_=>_.wordId));for(const[_,p]of o.sha1s.entries()){const P=o.annotated[p];if(P){const E=o.contents[_],g=P.hits.filter(m=>i.has(m.wordId));for(const{wordId:m}of g)h.set(m,(h.get(m)||[]).concat({sentence:E,lino:_}))}}}function C(i,_,p,P){y.upsert(W(c,d),E=>{const g=E?.hits;if(!E||!g)return!1;const m=K(_),j=g.findIndex(R=>R.wordId===i.wordId&&K(R.run)===m);if(j>=0){const R=g.splice(j,1)}else{const R={run:_,startIdx:p,endIdx:P,wordId:i.wordId,summary:i.summary};g.push(R)}return E})}const I=u.furigana[a],k=u.kanjidic||{},x=$(I).split("").filter(i=>i in k).map(i=>k[i]),U=x.length?t("div",null,t("h3",null,"Kanjidic"),t("ol",null,...x.map(i=>t("li",null,summarizeCharacter(i),i.dependencies?.length?t("ul",null,...i.dependencies.map(_=>t("li",null,_.nodeMapped?summarizeCharacter(_.nodeMapped):_.node))):void 0)))):"",N=new Set(l.results.flatMap(i=>i.results.map(_=>_.wordId))),B=r?.hits?.filter(i=>N.has(i.wordId))||[],w=B.length?t("div",null,t("h3",null,"All uses"),t("ul",null,...B.map(i=>t("li",null,i.summary,t("ol",null,...(h.get(i.wordId)||[]).map(({sentence:_,lino:p})=>t("li",null,t("a",{href:`#${c}-${p}`},De(i.run,_))))))))):"";return t("div",null,t("button",{onClick:T(()=>J.click=void 0)},"close"),...l.results.map(i=>t("ol",null,...i.results.map(_=>{const p=f.has(_.wordId+K(i.run)),P=te.get(_.wordId)||[],E=p?[t("button",{onClick:()=>{M.upsert(Q(_.wordId),g=>{if(!g.wordId)return{wordId:_.wordId,memoryType:"jmdictWordId",summary:_.summary,ebisus:{[X.kana2meaning]:ce()}};const m=g.ebisus||{};return m.kana2meaning?delete m.kana2meaning:m.kana2meaning=ce(),g.ebisus=m,g})}},P.includes(X.kana2meaning)?"Unlearn kana?":"Mark kana as learned!")]:[];return t("li",{className:p?"annotated-entry":void 0},...qe(i.run,_.summary),t("button",{onClick:()=>C(_,i.run,l.startIdx,i.endIdx)},p?"Entry highlighted! Remove?":"Create highlight?"),...E)}))),U,w,t(Ce,{key:`${o.unique}${s}${a}`}))});function Ce({}){const n=J.click;if(!n)return t(V);const{doc:e,lineNumber:o,morphemeNumber:s}=n,a=e.raws[e.sha1s[o]]?.furigana[s]||[],u=e.annotated[e.sha1s[o]]?.furigana[s]||a,r=u.filter(w=>typeof w!="string"),c=$(u),d=r.map(w=>w.rt),l=c in e.overrides,[f,h]=z(d),[C,I]=z(l);if(r.length===0)return t(V);const k=f.map((w,i)=>t("input",{type:"text",value:w,onChange:_=>h(f.map((p,P)=>P===i?_.target.value:p))})),x=t("input",{type:"checkbox",name:"globalCheckbox",checked:C,onChange:()=>I(!C)}),U=t("label",{htmlFor:"globalCheckbox"},"Global override?"),N=t("button",{onClick:()=>{const w=[];{let i=0;for(const _ of a)w.push(typeof _=="string"?_:{ruby:_.ruby,rt:f[i++]})}C?y.upsert(O(e.unique),i=>(i.overrides={...i.overrides,[c]:w},i)):y.upsert(W(e.unique,e.sha1s[o]),i=>(i.furigana&&(i.furigana[s]=w),i))}},"Submit override"),B=t("button",{onClick:()=>{h(d),I(l)}},"Cancel");return t("div",null,t("h3",null,"Override for: "+c),t("ol",null,...r.map((w,i)=>t("li",null,w.ruby+" ",k[i]))),U,x,N)}function xe({doc:n}){const e=n.overrides,o=Object.keys(e);return o.length===0?t(V):t("div",null,t("h3",null,"Overrides"),t("ol",null,...o.map(s=>{const a=()=>{y.upsert(O(n.unique),c=>{const d=c.overrides||{};return delete d[s],c.overrides=d,c})},u=e[s].map(c=>typeof c=="string"?c:t("ruby",null,c.ruby,t("rt",null,c.rt))),r=t("button",{onClick:a},"Delete");return t("li",null,`${s} → `,...u," ",r)})))}function je(){const[n,e]=z([]),o=t("button",{onClick:()=>be().then(a=>e(a))},"Refresh deleted docs"),s=a=>y.upsert(O(a.unique),()=>a);return t("div",null,t("h2",null,"Deleted"),o,t("ol",null,...n.map(a=>t("li",null,`${a.name} (${a.unique}): ${a.contents.join(" ").slice(0,15)}…`,t("button",{onClick:()=>s(a)},"Undelete")))))}function Se(){return t("button",{onClick:async()=>{const n=await ne(),e=await se(M),o=new Blob([JSON.stringify({docs:n,memories:e})],{type:"application/json"}),s=document.createElement("a");s.href=URL.createObjectURL(o),s.download=`kanda-${new Date().toISOString().replace(/:/g,".")}.json`,document.body.appendChild(s),s.click()}},"Export")}function De(n,e){const o=K(n),s=e.indexOf(o);return s<0?e:"…"+e.slice(Math.max(0,s-5),s+o.length+5)+"…"}function qe(n,e){const o=new Set((typeof n=="string"?n:n.cloze).split(""));return e.split("").map(s=>o.has(s)?t("span",{className:"highlighted"},s):s)}export function summarizeCharacter(n){const{literal:e,readings:o,meanings:s,nanori:a}=n;return`${e}： ${o.join(", ")} ${s.join("; ")}`+(a.length?` (names: ${a.join(", ")})`:"")}async function Te(n,e){const o=new TextEncoder().encode(n),s=await crypto.subtle.digest(e,o);return Array.from(new Uint8Array(s),a=>a.toString(16).padStart(2,"0")).join("")}function K(n){return typeof n=="string"?n:`${n.left}${n.cloze}${n.right}`}function $(n){return n.map(e=>typeof e=="string"?e:e.ruby).join("")}function ie(n){return n.map(e=>typeof e=="string"?e:e.rt).join("")}function Me(n,e,o=0){if(e.length>n.length)return-1;e:for(let s=o;s<n.length-e.length+1;s++){for(let a=0;a<e.length;a++)if(n[s+a]!==e[a])continue e;return s}return-1}function Oe(n,e){const o=n.indexOf(e);return o>=0&&n.indexOf(e,o+1)<0}function Ae(n,e,o){const s=n+e+o;let a="",u="",r=0;for(;!Oe(s,a+e+u);){if(r++,r>n.length&&r>o.length)throw console.error({sentence:s,left:n,cloze:e,right:o,leftContext:a,rightContext:u,contextLength:r}),new Error("Ran out of context to build unique cloze");a=n.slice(-r),u=o.slice(0,r)}return{left:a,cloze:e,right:u}}function $e(n){return!n.right&&!n.left?n.cloze:n}function Ne(n){return typeof n=="string"?n:n.cloze}function ce(n=Date.now()){return{epoch:n,memory:Z.defaultModel(1,2.5)}}const ue=1/36e5;
