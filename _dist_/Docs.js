import"./Docs.css.proxy.js";import{createElement as e,Fragment as z,useEffect as B,useState as I}from"../web_modules/react.js";import E from"../web_modules/recoil.js";const q="https://curtiz-japanese-nlp.glitch.me/api/v1/sentences",j=E.atom({key:"docs",default:{}}),G=E.selectorFamily({key:"doc",get:t=>({get:n})=>n(j)[t]}),T=E.atom({key:"clickedMorpheme",default:void 0});import F from"../web_modules/pouchdb-browser.js";import J from"../web_modules/pouchdb-upsert.js";F.plugin(J);const k=new F("sidecar-docs");function A(t){return`doc-${t}`}async function H(){const t=A(""),n=await k.allDocs({startkey:t,endkey:t+"️",include_docs:!0}),a={};for(const{doc:o}of n.rows)if(o){const r={name:o.name,unique:o.unique,contents:o.contents,raws:o.raws,annotated:o.annotated,overrides:o.overrides};a[o.unique]=r}return a}async function V(t){return k.upsert(A(t),()=>({_deleted:!0}))}async function K(){const t=[];return new Promise((n,a)=>{k.changes({filter:o=>o._deleted}).on("change",o=>t.push(o.id)).on("complete",()=>{n(t)}).on("error",o=>a(o))})}async function W(){const t=await K(),n=await Promise.all(t.map(o=>k.get(o,{revs:!0,open_revs:"all"}).then(r=>{const s=r[0].ok._revisions,i=s.start-1+"-"+s.ids[1],R=k.get(o,{rev:i});return R}))),a=n.map(({name:o,unique:r,contents:s,raws:i,annotated:R,overrides:m})=>({name:o,unique:r,contents:s,raws:i,annotated:R,overrides:m}));return a}export function DocsComponent({}){const[t,n]=E.useRecoilState(j),[a,o]=I(!1);B(()=>{a||(async()=>{const i=await H();Object.keys(i).length>0&&n(i),o(!0)})()},[a]);const r=e("div",{id:"all-docs",className:"left-containee"},...Object.keys(t).map(i=>e(Q,{unique:i})),e(M),e(nt),e(st)),s=e("div",{className:"right-containee"},e(Z));return e("div",{className:"container"},r,s)}function Q({unique:t}){const n=E.useRecoilValue(G(t)),a=E.useSetRecoilState(j),o=E.useSetRecoilState(T),[r,s]=I(!1);if(!n)return e(z);const i=e("button",{onClick:()=>V(t).then(()=>a(u=>{const f={...u};return delete f[t],f}))},"Delete"),R=e("button",{onClick:()=>s(!r)},r?"Cancel":"Edit"),m=n.overrides,g=r?e(M,{existing:n,done:()=>s(!r)}):e("section",null,...n.raws.map((u,f)=>u?e(Y,{rawAnalysis:u,annotated:n.annotated[f],docUnique:t,lineNumber:f,overrides:m}):e("p",{onClick:()=>o(void 0)},n.contents[f])));return e("div",{className:"doc"},e("h2",null,n.name||t,i,R),g,e(ot,{overrides:n.overrides,docUnique:t}),e(X,{doc:n}))}function X({doc:t}){return e("details",{className:"regular-sized limited-height"},e("summary",null,"All dictionary annotations"),e("ol",null,...t.annotated.flatMap(n=>n?.hits.map(a=>e("li",null,a.summary))).filter(n=>!!n)))}function Y({rawAnalysis:t,docUnique:n,lineNumber:a,annotated:o,overrides:r}){const s=E.useSetRecoilState(T),{furigana:i,hits:R}=t,m={docUnique:n,lineNumber:a,annotations:o,overrides:r},g=new Set();if(o)for(const{startIdx:f,endIdx:y}of o.hits)for(let b=f;b<y;b++)g.add(b);const u=g.size>0?f=>g.has(f)?"annotated-text":void 0:()=>{};return e("p",null,...i.map((f,y)=>o?.furigana[y]||r[D(f)]||f).flatMap((f,y)=>f.map(b=>{const l={...m,rawHits:R[y],morpheme:{rawFurigana:t.furigana[y],annotatedFurigana:o?.furigana[y]},morphemeIdx:y,kanjidic:t.kanjidic||{}};return typeof b=="string"?e("span",{className:u(y),onClick:()=>s(l)},b):e("ruby",{className:u(y),onClick:()=>s(l)},b.ruby,e("rt",null,b.rt))})))}function M({existing:t,done:n}){const[a,o]=I(t?t.name:""),[r,s]=I(t?t.contents.join(`
`):""),i=E.useSetRecoilState(j),R=e("input",{type:"text",value:a,onChange:u=>o(u.target.value)}),m=e("textarea",{value:r,onChange:u=>s(u.currentTarget.value)}),g=e("button",{onClick:async()=>{const u=r.split(`
`);let f=new Map(t?t.contents.map((l,d)=>[l,d]):[]),y=t?u.filter(l=>!f.has(l)):u;const b=await fetch(q,{body:JSON.stringify({sentences:y}),headers:{"Content-Type":"application/json"},method:"POST"});if(b.ok){const l=[],d=[],x=await b.json();{let h=0;for(const w of u){const c=f.get(w);if(t&&c!==void 0)l.push(t.raws[c]),d.push(t.annotated[c]);else{const p=x[h];l.push(typeof p=="string"?void 0:{sha1:await at(w,"sha-1"),text:w,hits:p.hits,furigana:p.furigana,kanjidic:p.kanjidic}),d.push(void 0),h++}}}const S=t?t.unique:new Date().toISOString();l.length===d.length&&d.length===u.length||console.error("Warning: unexpected length of lines vs raw analysis vs annotated analysis",{raws:l,annotated:d,contents:u});const C={name:a,unique:S,contents:u,raws:l,annotated:d,overrides:t?t.overrides:{}};if(t)for(const[h,w]of t.annotated.entries()){const c=C.raws[h],p=t.raws[h];if(!w||!c||!p||C.annotated[h])continue;const _={sha1:c.sha1,text:c.text,furigana:[],hits:[]},P=new Map();for(const v of w.furigana)v&&P.set(D(v),v);_.furigana=c.furigana.map(v=>P.get(D(v))||v);const U=c.furigana.map(D);for(const v of w.hits){const $=p.furigana.slice(v.startIdx,v.endIdx).map(D),O=rt(U,$);if(O>=0){const L=ct(lt(U.slice(0,O).join(""),$.join(""),U.slice(O+$.length).join("")));_.hits.push({summary:v.summary,wordId:v.wordId,run:L,startIdx:O,endIdx:O+$.length})}}C.annotated[h]=_}k.upsert(A(S),()=>C).then(()=>i(h=>({...h,[S]:C}))).then(()=>n?n():"")}else console.error("error parsing sentences: "+b.statusText)}},"Submit");return e("div",null,t?"":e("h2",null,"Create a new document"),R,e("br"),m,e("br"),g)}function Z({}){const t=E.useRecoilValue(T),n=E.useSetRecoilState(j),a=E.useSetRecoilState(T);if(!t)return e("div",null);const{rawHits:o,annotations:r,lineNumber:s,docUnique:i,morphemeIdx:R,morpheme:{rawFurigana:m},kanjidic:g}=t,u=new Set();if(r)for(const{wordId:l,run:d}of r.hits)u.add(l+N(d));function f(l,d,x,S){n(C=>{const h={...C},w=C[i];if(w){const c={...w};c.annotated=c.annotated.slice();const p=c.annotated[s];if(p){const _=N(d),P=p.hits.findIndex(U=>U.wordId===l.wordId&&N(U.run)===_);if(P>=0){const U=p.hits.slice();U.splice(P,1),c.annotated[s]={...p,hits:U}}else{const U={run:d,startIdx:x,endIdx:S,wordId:l.wordId,summary:l.summary};c.annotated[s]={...p,hits:p.hits.concat(U)}}}else{const _={run:d,startIdx:x,endIdx:S,wordId:l.wordId,summary:l.summary};c.annotated[s]={furigana:Array.from(Array(c.raws[s]?.furigana.length)),hits:[_],sha1:c.raws[s]?.sha1||"",text:c.raws[s]?.text||""}}h[i]=c,a(_=>_&&{..._,annotations:c.annotated[s]}),k.upsert(A(i),()=>({...c}))}return h})}const y=D(m).split("").filter(l=>l in g).map(l=>g[l]),b=y.length?e("div",null,e("h3",null,"Kanjidic"),e("ol",null,y.map(l=>e("li",null,summarizeCharacter(l),l.dependencies?.length?e("ul",null,...l.dependencies.map(d=>e("li",null,d.nodeMapped?summarizeCharacter(d.nodeMapped):d.node))):void 0)))):"";return e("div",null,...o.results.map(l=>e("ol",null,...l.results.map(d=>{const x=u.has(d.wordId+N(l.run));return e("li",{className:x?"annotated-entry":void 0},...tt(l.run,d.summary),e("button",{onClick:()=>f(d,l.run,o.startIdx,l.endIdx)},x?"Entry highlighted! Remove?":"Create highlight?"))}))),e(et,{morpheme:t.morpheme,overrides:t.overrides,docUnique:i,lineNumber:s,morphemeIdx:R,key:`${i}${s}${R}`}),b)}function tt(t,n){const a=new Set((typeof t=="string"?t:t.cloze).split(""));return n.split("").map(o=>a.has(o)?e("span",{className:"highlighted"},o):o)}export function summarizeCharacter(t){const{literal:n,readings:a,meanings:o,nanori:r}=t;return`${n}： ${a.join(", ")} ${o.join("; ")}`+(r.length?` (names: ${r.join(", ")})`:"")}function et({morpheme:t,overrides:n,docUnique:a,lineNumber:o,morphemeIdx:r}){const s=(t?.annotatedFurigana||t?.rawFurigana||[]).filter(h=>typeof h!="string"),i=D(t?.annotatedFurigana||t?.rawFurigana||[]),R=E.useSetRecoilState(j),m=s.map(h=>h.rt),g=i in n,[u,f]=I(m),[y,b]=I(g);if(s.length===0||!t)return e(z);const l=u.map((h,w)=>e("input",{type:"text",value:h,onChange:c=>f(u.map((p,_)=>_===w?c.target.value:p))})),d=e("input",{type:"checkbox",name:"globalCheckbox",checked:y,onChange:()=>b(!y)}),x=e("label",{htmlFor:"globalCheckbox"},"Global override?"),S=e("button",{onClick:()=>{R(h=>{const w=[];{let _=0;for(const P of t.rawFurigana)w.push(typeof P=="string"?P:{ruby:P.ruby,rt:u[_++]})}const c=h[a],p=c?.raws[o];if(c&&p){const _={...c};if(y)_.overrides={..._.overrides,[i]:w};else{_.annotated=_.annotated.slice();const P=_.annotated[o]?{..._.annotated[o]}:{text:p.text,sha1:p.sha1,furigana:Array.from(Array(p.furigana.length)),hits:[]};P.furigana=P.furigana.slice(),P.furigana[r]=w,_.annotated[o]=P}return k.upsert(A(a),()=>({..._})),{...h,[a]:_}}return h})}},"Submit override"),C=e("button",{onClick:()=>{f(m),b(g)}},"Cancel");return e("div",null,e("h3",null,"Override for: "+i),e("ol",null,...s.map((h,w)=>e("li",null,h.ruby+" ",l[w]))),x,d,S)}function nt(){const t=E.useSetRecoilState(j),[n,a]=I([]),o=e("button",{onClick:()=>W().then(s=>a(s))},"Refresh deleted docs"),r=s=>k.upsert(s.unique,()=>s).then(()=>t(i=>({...i,[s.unique]:s})));return e("div",null,e("h2",null,"Deleted"),o,e("ol",null,...n.map(s=>e("li",null,`${s.name} (${s.unique}): ${s.contents.join(" ").slice(0,15)}…`,e("button",{onClick:()=>r(s)},"Undelete")))))}function ot({overrides:t,docUnique:n}){const a=E.useSetRecoilState(j),o=Object.keys(t);return o.length===0?e(z):e("div",null,e("h3",null,"Overrides"),e("ol",null,...o.map(r=>{const s=()=>a(m=>{const g={...m[n]};return g.overrides={...g.overrides},delete g.overrides[r],k.upsert(A(n),()=>({...g})),{...m,[n]:g}}),i=t[r].map(m=>typeof m=="string"?m:e("ruby",null,m.ruby,e("rt",null,m.rt))),R=e("button",{onClick:s},"Delete");return e("li",null,`${r} → `,...i," ",R)})))}function st(){return e("button",{onClick:async()=>{const t=await H(),n=new Blob([JSON.stringify(t)],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(n),a.download=`kanda-${new Date().toISOString().replace(/:/g,".")}.json`,document.body.appendChild(a),a.click()}},"Export")}async function at(t,n){const a=new TextEncoder().encode(t),o=await crypto.subtle.digest(n,a),r=Array.from(new Uint8Array(o)),s=r.map(i=>i.toString(16).padStart(2,"0")).join("");return s}function N(t){return typeof t=="string"?t:`${t.left}${t.cloze}${t.right}`}function D(t){return t.map(n=>typeof n=="string"?n:n.ruby).join("")}function rt(t,n,a=0){if(n.length>t.length)return-1;t:for(let o=a;o<t.length-n.length+1;o++){for(let r=0;r<n.length;r++)if(t[o+r]!==n[r])continue t;return o}return-1}function it(t,n){const a=t.indexOf(n);return a>=0&&t.indexOf(n,a+1)<0}function lt(t,n,a){const o=t+n+a;let r="",s="",i=0;for(;!it(o,r+n+s);){if(i++,i>t.length&&i>a.length)throw console.error({sentence:o,left:t,cloze:n,right:a,leftContext:r,rightContext:s,contextLength:i}),new Error("Ran out of context to build unique cloze");r=t.slice(-i),s=a.slice(0,i)}return{left:r,cloze:n,right:s}}function ct(t){return!t.right&&!t.left?t.cloze:t}
